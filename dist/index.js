var ge=(t=>(t.CALC="antetype.illustrator.calc",t))(ge||{});var P=(e=>(e.CALC="antetype.workspace.calc",e))(P||{}),pe=(e=>(e.WEBP="image/webp",e.PNG="image/png",e.JPG="image/jpeg",e))(pe||{}),N=(e=>(e.CALC="antetype.cursor.calc",e.POSITION="antetype.cursor.position",e.DOWN="antetype.cursor.on.down",e.UP="antetype.cursor.on.up",e.MOVE="antetype.cursor.on.move",e.SLIP="antetype.cursor.on.slip",e.RESIZED="antetype.cursor.on.resized",e))(N||{}),B={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"},je=class{#e;#t=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(e){this.#e=e}async#i(e,t){let i=this.#e.minstrel.getResourceUrl(this,"core.js");return this.#t=(await import(i)).default,this.#t({canvas:t,modules:e,herald:this.#e.herald})}async register(e){let{modules:t,canvas:i}=e.detail;t.core=await this.#i(t,i)}static subscriptions={[B.MODULES]:"register"}},he=(e=>(e.SAVE="antetype.memento.save",e))(he||{}),Ye=class{#e;#t=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(e){this.#e=e}async register(e){let{modules:t,canvas:i}=e.detail;if(!this.#t){let r=this.#e.minstrel.getResourceUrl(this,"module.js");this.#t=(await import(r)).default}t.memento=this.#t({canvas:i,modules:t,herald:this.#e.herald})}static subscriptions={[B.MODULES]:"register"}},R={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"},Xe=class{#canvas;#modules;#herald;#ctx;#translationSet=0;#drawWorkspace=!0;#isExporting=!1;#quality=1;#scale=1;#translate={left:0,top:0};constructor(e,t,i){if(!e)throw new Error("[Antetype Workspace] Provided canvas is empty");this.#canvas=e,this.#updateCanvas(),this.#modules=t,this.#ctx=this.#canvas.getContext("2d"),this.#observeCanvasResize(),this.#herald=i,this.subscribe()}subscribe(){let e=this.#herald.batch([{event:R.CLOSE,subscription:()=>{e()}},{event:"antetype.workspace.calc",subscription:this.calcEventHandle.bind(this)},{event:R.DRAW,subscription:[{method:t=>{let{element:i}=t.detail,r={clear:this.clearCanvas.bind(this),workspace:this.drawWorkspace.bind(this)}[i.type];typeof r=="function"&&r(i)},priority:1},{method:()=>{this.setOrigin()},priority:-255},{method:()=>{this.restore()},priority:255}]},{event:N.POSITION,subscription:t=>{t.detail.x-=this.getLeft(),t.detail.y-=this.getTop()}},{event:N.CALC,subscription:this.calcEventHandle.bind(this)},{event:R.SETTINGS,subscription:t=>{t.detail.settings.push(this.getSettingsDefinition())}},{event:"antetype.conditions.method.register",subscription:t=>{this.handleConditionsMethodRegisterMethod(t)}}])}calcEventHandle(e){let t=e.detail.values,i=Object.keys(t);for(let r of i)t[r]=this.calc(t[r])}#observeCanvasResize(){new ResizeObserver(()=>{!this.#updateCanvas()||!this.#modules.core||this.#modules.core.view.recalculate().then(()=>{this.#modules.core.view.redraw()})}).observe(this.#canvas)}#updateCanvas(){let e=this.#canvas.offsetWidth*this.#quality,t=this.#canvas.offsetHeight*this.#quality,i=Number(this.#canvas.getAttribute("width")),r=Number(this.#canvas.getAttribute("height"));return!t||!e||i===e&&r===t?!1:(this.#canvas.setAttribute("height",String(t)),this.#canvas.setAttribute("width",String(e)),!0)}setTranslateLeft(e){this.#translate.left=e}setTranslateTop(e){this.#translate.top=e}getTranslate(){return this.#translate}setQuality(e){if(isNaN(e))throw new Error("Workspace quality must be a number");this.#quality=Number(e),this.#updateCanvas()}getQuality(){return this.#quality}getScale(){return this.#scale}setScale(e){if(isNaN(e))throw new Error("Workspace scale must be a number");this.#scale=e}scale(e){return e*this.#scale*this.#quality}typeToExt(e){return e=="image/png"?"png":e=="image/jpeg"?"jpg":"webp"}async download(e){let t=document.createElement("a");t.download=e.filename+"."+this.typeToExt(e.type);let i=URL.createObjectURL(await this.export(e));t.href=i,t.click(),URL.revokeObjectURL(i)}#updateQualityBasedOnDpi(e){let t=e*11.692913385826772,i=this.getSize().height/this.#quality;this.setQuality(t/i)}async export({type:e="image/webp",quality:t=.9,dpi:i=300}={}){let r=this.#modules.core.view,o=this.#drawWorkspace;try{this.#drawWorkspace=!1,this.setExporting(!0),this.#updateQualityBasedOnDpi(i),this.#updateCanvas(),await r.recalculate(),r.redraw();let n=await this.#canvasToBlob(e,t);if(!n)throw new Error("Couldn't export canvas workspace");return n}finally{this.#drawWorkspace=o,this.setExporting(!1),this.setQuality(1),this.#updateCanvas(),await r.recalculate(),r.redraw()}}#canvasToBlob(e="image/webp",t=.9){let{width:i,height:r}=this.getSize(),o=this.getTop(),n=this.getLeft(),a=this.#ctx.getImageData(n,o,i,r),s=document.createElement("canvas");return s.width=i,s.height=r,s.getContext("2d").putImageData(a,0,0),new Promise(l=>{let u=setTimeout(()=>{l(null)},3e4);s.toBlob(c=>{clearTimeout(u),l(c)},e,t)})}clearCanvas(){this.#ctx.clearRect(-this.getLeft(),-this.getTop(),this.#canvas.width,this.#canvas.height)}setExporting(e){this.#isExporting=e}isExporting(){return this.#isExporting}drawWorkspace(){if(this.#isExporting)return;let e=this.#ctx;e.save();let{height:t,width:i}=this.getSize();e.fillStyle="#FFF",e.fillRect(0,0,i,t),e.restore()}getLeft(){let e=this.#ctx,{width:t}=this.getSize();return(Number(e.canvas.getAttribute("width"))-t)/2+this.getTranslate().left}getTop(){let e=this.#ctx,{height:t}=this.getSize();return(Number(e.canvas.getAttribute("height"))-t)/2+this.getTranslate().top}setOrigin(){if(this.#translationSet++,this.#translationSet>1)return;let e=this.#ctx;e.save(),e.translate(this.getLeft(),this.getTop())}restore(){this.#translationSet--,this.#translationSet==0&&this.#ctx.restore()}toRelative(e,t="x",i=3){let{height:r,width:o}=this.#getSizeRelative();e=Math.round((e+Number.EPSILON)*10**i)/10**i;let n=e/r*100,a="h%";return t==="x"&&(n=e/o*100,a="w%"),String(Math.round((n+Number.EPSILON)*10**i)/10**i)+a}calc(operation,quiet=!1){if(typeof operation=="number")return this.scale(operation);if(typeof operation!="string"||operation.match(/[^-()\d/*+.pxw%hv ]/g))return console.warn("Calculation contains invalid characters!",operation),NaN;let convertUnitToNumber=(e,t=2)=>Number(e.slice(0,e.length-t)),{height:aHeight,width:aWidth}=this.getSize(),{height,width}=this.#getSizeRelative(),unitsTranslator={px:e=>convertUnitToNumber(e),"w%":e=>convertUnitToNumber(e)/100*width,"h%":e=>convertUnitToNumber(e)/100*height,vh:e=>convertUnitToNumber(e)/100*aHeight,vw:e=>convertUnitToNumber(e)/100*aWidth,default:e=>e},calculation="";operation.split(" ").forEach(e=>{e=e.trim();let t=e[e.length-1],i=e[e.length-2],r=(unitsTranslator[i+t]||unitsTranslator.default)(e);typeof r=="number"&&(r=this.#decimal(r)),calculation+=String(r)});let result;try{result=eval(calculation)}catch(e){result=void 0,quiet||console.warn("Invalid calculation! Tried to calculate from",calculation)}return result==null?NaN:this.#decimal(result)}#decimal(e,t=2){return+e.toFixed(t)}#getSystem(){return this.#modules.core}#getSettings(){let e=this.#ctx.canvas.offsetHeight,t=this.#getSystem().setting.get("workspace")??{};if(isNaN(Number(t.height))&&(t.height=e),isNaN(Number(t.width))){let i=.707070707;t.width=Math.round(e*i)}return t}getSize(){let{width:e,height:t}=this.#getSettings(),i=e/t,r=this.#ctx.canvas.offsetHeight,o=r*i;return o>this.#ctx.canvas.offsetWidth&&(o=this.#ctx.canvas.offsetWidth,r=o/i),{width:this.scale(o),height:this.scale(r)}}#getSizeRelative(){let e=this.#getSettings(),{width:t,height:i}=this.getSize(),r=e.relative?.width??t,o=e.relative?.height??i,n=r/o,a={width:e.relative?.width??0,height:e.relative?.height??0},s=this.#ctx.canvas.offsetHeight;return a.width||(a.width=this.scale(s*n)),a.height||(a.height=this.scale(s)),a.width>this.scale(this.#ctx.canvas.offsetWidth)&&(a.width=this.scale(this.#ctx.canvas.offsetWidth),a.height=this.scale(this.#ctx.canvas.offsetWidth/n)),{width:a.width,height:a.height}}handleConditionsMethodRegisterMethod(e){let{methods:t}=e.detail;t.hideOnExport={name:"Hide on export",type:"hide-export",resolve:({event:i})=>{this.isExporting()&&(i.detail.element=null)}}}getSettingsDefinition(){let e=this.#getSettings();return{details:{label:"Workspace"},name:"workspace",tabs:[{label:"General",fields:[[{label:"Dimensions",type:"container",fields:[[{label:"Height",type:"number",name:"height",value:e.height},{label:"Width",type:"number",name:"width",value:e.width}]]}]]}]}}};async function S(e,t){if(t.type==="linear"){let i=t.style;i.pos=await e.calc({layerType:"polygon-fill-linear",purpose:"position",values:i.pos}),i.size=await e.calc({layerType:"polygon-fill-linear",purpose:"size",values:i.size})}return t}function y(e,t){let i={default:r=>r,linear:r=>me(r.colors,r.pos.x,r.pos.y,r.size.w,r.size.h)};return(i[e]||i.default)(t)}var me=(e,t,i,r,o)=>{let s=document.createElement("canvas").getContext("2d").createLinearGradient(t,i,r,o);return e.forEach(l=>{s.addColorStop(l.offset,l.color)}),s};var d={line:(e,t,i)=>{e.lineTo(t,i)},curve:(e,t,i,r,o,n,a)=>{e.bezierCurveTo(t,i,r,o,n,a)},stroke:(e,t=5,i="#000",r="round",o=2)=>{e.save(),e.strokeStyle=i,e.lineWidth=t,e.lineJoin=r,e.miterLimit=o,e.stroke(),e.restore()},begin:(e,t,i)=>{e.beginPath(),e.moveTo(t,i)},move:(e,t,i)=>{e.moveTo(t,i)},fill:(e,t)=>{t.type||(t.type="default");let i=e.fillStyle;e.fillStyle=y(t.type,t.style),e.fill(),e.fillStyle=i},close:e=>{e.closePath()},default:(e,t,i)=>d.line(e,t,i)};function U(e,t,i,r){let o={fill:n=>{d.fill(e,n.args)},line:n=>{d.line(e,n.args.x+i,n.args.y+r)},curve:n=>{d.curve(e,n.args.cp1x+i,n.args.cp1y+r,n.args.cp2x+i,n.args.cp2y+r,n.args.x+i,n.args.y+r)},stroke:n=>{d.stroke(e,n.args.thickness??5,n.args.fill??"#000",n.args.lineJoin??"round",n.args.miterLimit??2)},begin:n=>{d.begin(e,n.args.x+i,n.args.y+r)},move:n=>{d.move(e,n.args.x+i,n.args.y+r)},close:()=>d.close(e)};o[t.means]&&o[t.means](t)}var _=Symbol("error"),M=Symbol("timeout"),k=Symbol("loading"),v=class{image;coords;constructor(t,i){this.image=t,this.coords=i}},j=(e,t)=>{let i=t.image.calculated;if(!i||ye(i)||de(i)||!(i instanceof v))return;let{start:{x:r,y:o}}=t.area;e.drawImage(i.image,r+i.coords.xDiff,o+i.coords.yDiff,i.coords.width,i.coords.height)},ye=e=>e===M,de=e=>e===k;var Y=e=>String(e.text.font?.size??10),F=e=>Number(e.text.font?.size??10),z=()=>"\u200A",X=(e,t)=>{let{x:i}=t.start,r=[],o=0,{start:{y:n},size:{w:a},text:s}=t,{columns:l,transY:u,lineHeight:c}=s,g=[...s.lines],p=Math.ceil(g.length/l.amount),{textBaseline:I="top"}=t.text;for(e.save(),e.font=G(t,e,String(F(t))),e.textBaseline=I;(r=g.splice(0,p)).length;)r.forEach((h,f)=>{let w=r[f+1]||g[0]||[""],b=f+1==r.length||w[0]==""||h[0][h[0].length-1]==`
`,x=u+(h[1]-o)*c;fe(e,h[0],t,i,n,a,x,b)}),o+=r[r.length-1][1]+1,i+=l.gap+a;e.restore()},fe=(e,t,i,r,o,n,a,s)=>{let{color:l="#000",outline:u=null}=i.text,c=i.text.align?.horizontal||"left";c!="left"&&({text:t,x:r}=Ie(e,c,t,n,s,r)),a>0&&(o=o+a),e.fillStyle=typeof l=="object"?y(l.type,l.style):l,u&&ve(e,u,t,r,o,n),e.fillText(t,r,o,n)},ve=(e,t,i,r,o,n)=>{t.fill?.style&&(e.strokeStyle=y(t.fill.type,t.fill.style),e.lineWidth=t.thickness,e.lineJoin=t.lineJoin??"round",e.miterLimit=t.miterLimit??2,e.strokeText(i,r,o,n))},Ie=(e,t,i,r,o,n)=>{let a=e.measureText(i),s=a.width;if(t=="center"){let l=(r-s)/2;l>0&&(n=n+l)}else t=="right"?n=n+r-s:t=="justify"&&!o&&(i=we(i,a,r,e));return{text:i,x:n}},we=(e,t,i,r)=>{if(t.width>=i)return e;let o=e.split(" "),n=r.measureText(z()),a=Math.floor((i-t.width)/n.width),s=a/(o.length-1);for(let l=0;l<o.length-1;l++)o[l]+=z().repeat(s);return o.join(" ")},G=(e,t,i)=>{let{font:r=null}=e.text;if(!r)return t.font;i=i+"px ";let o=(r.family||"serif")+" ",n=(r.weight??100)+" ",a="";return r.style&&(a+=r.style+" "),r.variant&&(a+=r.variant+" "),a+=n,r.stretch&&(a+=r.stretch+" "),a+=i,r.height&&(a+="/"+r.height+" "),a+o};var q=(e,t,i)=>{let{group:r,start:o}=i;i.layout.length!==0&&(e.save(),e.translate(o.x,o.y),r.interaction==="fixed"?t.core.view.redraw(i.layout):be(e,t,i),e.restore())},O=(e,t)=>{let i=0,r=e.group.gap.horizontal;return t.forEach(o=>{i+=o.height+r}),i-r},H=(e,t)=>{let i=0,r=e.group.gap.vertical;return t.forEach(o=>{e.group.direction==="column"?i=Math.max(i,o.width):i+=o.width+r}),e.group.direction==="row"&&(i-=r),i},be=(e,t,i)=>{let{group:r}=i,{vertical:o,horizontal:n}=r.gap,a=W(i,i.layout);r.clip&&(!isNaN(i.size?.w)||!isNaN(i.size?.h))&&(e.beginPath(),e.rect(0,0,isNaN(i.size.w)?H(i,a):i.size.w,isNaN(i.size.h)?O(i,a):i.size.h),e.clip());let s=0,l=0;a.forEach(u=>{u.layers.forEach(c=>{c.def.start.x=l,c.def.start.y=s,c.def.area&&(c.def.area.start.x=l,c.def.area.start.y=s),t.core.view.draw(c.def),l+=c.def.size.w+o}),l=0,s+=u.height+n})},W=(e,t)=>{let{size:i}=e,r=[],o=()=>({height:0,width:0,layers:[]}),n=o();return t.forEach((a,s)=>{(e.group.wrap&&i.w!=0&&n.width+a.size.w>i.w||s!=0&&e.group.direction==="column")&&(r.push(n),n=o()),n.layers.push({x:n.width,def:a}),n.height<a.size.h&&(n.height=a.size.h),n.width+=a.size.w+e.group.gap.vertical}),r.push(n),r};var K=e=>{let t=e.polygon.size;return{start:{x:e.start.x+t.negative.x,y:e.start.y+t.negative.y},size:{w:t.positive.x-t.negative.x,h:t.positive.y-t.negative.y}}},J=async(e,t,i)=>{let r=i.illustrator,o={close:()=>{},fill:async n=>{await S(r,n.args)},line:async n=>{n.args=await r.calc({layerType:"polygon-line",purpose:"position",values:n.args}),m(e,n.args.x,"x"),m(e,n.args.y,"y")},curve:async n=>{n.args=await r.calc({layerType:"polygon-curve",purpose:"position",values:n.args}),m(e,n.args.x,"x"),m(e,n.args.cp1x,"x"),m(e,n.args.cp2x,"x"),m(e,n.args.y,"y"),m(e,n.args.cp2y,"y")},stroke:async n=>{n.args.thickness=(await r.calc({layerType:"polygon-stroke",purpose:"thickness",values:{thickness:n.args.thickness??5}})).thickness},begin:async n=>{n.args=await r.calc({layerType:"polygon-begin",purpose:"position",values:n.args}),m(e,n.args.x,"x"),m(e,n.args.y,"y")},move:async n=>{n.args=await r.calc({layerType:"polygon-move",purpose:"position",values:n.args})}};t.means||(t.means="line"),o[t.means]&&await o[t.means](t)},m=(e,t,i)=>{if(t<0){let r=e.polygon.size.negative;r[i]=Math.min(r[i],t)}else{let r=e.polygon.size.positive;r[i]=Math.max(r[i],t)}};var xe={},Q={},Te=e=>({start:{x:e.start.x,y:e.start.y},size:{h:e.size.h,w:e.size.w}}),Z=async(e,t)=>{let i=e.illustrator;t.size=await i.calc({layerType:"image",purpose:"size",values:t.size}),t.start=await i.calc({layerType:"image",purpose:"position",values:t.start}),t.area=Te(t),t.image?.outline?.thickness&&(t.image.outline.thickness=(await i.calc({layerType:"image",purpose:"thickness",values:{thickness:t.image.outline.thickness}})).thickness);let r=ee(t.image),o=Q[r];if(o){t.image.calculated=Ce(t,o);return}if(t.image.src instanceof Image){t.image.calculated=await $(t,t.image.src,e,r);return}if(typeof t.image.src!="string")return;let n=t.image.src;if(typeof n!="string"||!n.startsWith("blob:http")&&!n.startsWith("http")&&!n.startsWith("/")){console.warn("Image `"+n+"` has invalid source");return}let a=e.core.setting.get("illustrator.image.waitForLoad"),s=De(t,n,e);a&&await s},Ce=(e,t)=>{let i=e.image,{w:r,h:o}=e.size,{width:n,height:a}=te(i.fit??"default",t.width,t.height,r,o),s=re(i.align?.horizontal??"center",r,n),l=ie(i.align?.vertical??"center",o,a);return new v(t.image,{xDiff:s,yDiff:l,width:n,height:a})},$=async(e,t,i,r=null)=>{let o=e.image,{w:n,h:a}=e.size,s=t.width||200,l=t.height||200,{width:u,height:c}=te(o.fit??"default",s,l,n,a),g=re(o.align?.horizontal??"center",n,u),p=ie(o.align?.vertical??"center",a,c);return o.fit==="crop"&&(t=await Ae(t,e)),o.overcolor&&(t=await Se(t,e,u,c)),o.outline&&(t=await ze(t,e,u,c)),Q[r??ee(e.image)]={image:t,width:s,height:l},new v(t,{xDiff:g,yDiff:p,width:u,height:c})},ee=e=>JSON.stringify({...e,timeout:void 0,calculated:void 0}),De=async(e,t,i)=>{let r=new Image,{image:{timeout:o=3e4}}=e,n=i.core.view;r.crossOrigin="anonymous",r.src=t;let a=new Promise((s,l)=>{let u=setTimeout(()=>{e.image.calculated=M,l(new Error("Image loading reached a timeout: "+t))},o);r.onerror=c=>{clearTimeout(u),e.image.calculated=_,l(c)},r.onload=async()=>{clearTimeout(u),e.image.calculated=await $(e,r,i),n.redrawDebounce(),s()}});xe[t]=k,await a},Se=async(e,t,i,r)=>{let o=document.createElement("canvas"),n=o.getContext("2d"),a=t.image.overcolor;o.setAttribute("width",String(i)),o.setAttribute("height",String(r)),n.drawImage(e,0,0,i,r),n.globalCompositeOperation="source-in",n.fillStyle=y(a.fill.type,a.fill.style),n.fillRect(0,0,o.width,o.height),n.globalCompositeOperation="source-over";let s=await A(o,e);return n.drawImage(s,0,0,i,r),A(o,s)},ze=async(e,t,i,r)=>{let o=document.createElement("canvas"),n=o.getContext("2d"),a=t.image.outline;if(!a.thickness||!a.fill)return e;let s=a.thickness,l=[[-.75,-.75],[0,-1],[.75,-.75],[1,0],[.75,.75],[0,1],[-.75,.75],[-1,0]];if(s>5){let u=Math.floor(s/2.5),c=[];for(let g=0;g<l.length;g++){c.push(l[g]);let[p,I]=l[g],[h,f]=g+1===l.length?l[0]:l[g+1],w=p>h?-1:1,b=I>f?-1:1,x=Math.abs(p-h)/u*w,L=Math.abs(I-f)/u*b,V=[],C=p,D=I;for(;(w>0&&C+x<h||w<0&&C+x>h)&&(b>0&&D+L<f||b<0&&D+L>f);)C+=x,D+=L,V.push([C,D]);c=c.concat(V)}l=c}o.setAttribute("width",String(i+s*2)),o.setAttribute("height",String(r+s*2));for(let u=0;u<l.length&&(n.drawImage(e,s+l[u][0]*s,s+l[u][1]*s,i,r),s!==0);u++);return n.globalCompositeOperation="source-in",n.fillStyle=y(a.fill.type,a.fill.style),n.fillRect(0,0,o.width,o.height),n.globalCompositeOperation="source-over",n.drawImage(e,s,s,i,r),A(o,e)},A=async(e,t)=>{let i=new Image;return i.src=e.toDataURL("image/webp"),new Promise(r=>{let o=setTimeout(()=>{r(t)},1e3);i.onerror=()=>{clearTimeout(o),r(t)},i.onload=()=>{clearTimeout(o),r(i)}})},Ae=async(e,t)=>{let{w:i,h:r}=t.size,o=t.image.fitTo??"auto",n=0,a=0;o==="auto"&&(o=r>i?"height":"width"),o==="height"?n=(i-e.width*(r/e.height))/2:o==="width"&&(a=(r-e.height*(i/e.width))/2);let s=document.createElement("canvas"),l=s.getContext("2d");return s.setAttribute("width",String(i)),s.setAttribute("height",String(r)),l.drawImage(e,n,a,i-n*2,r-a*2),A(s,e)},te=(e,t,i,r,o)=>e==="stretch"||e==="crop"?{width:r,height:o}:Ee(t,i,r,o),Ee=(e,t,i,r)=>{let o=Math.min(i/e,r/t),n=e*o,a=t*o;return{width:n,height:a}},ie=(e,t,i)=>e=="top"?0:e=="bottom"?t-i:(t-i)/2,re=(e,t,i)=>e=="left"?0:e=="right"?t-i:(t-i)/2;var Le=e=>{let t=e.text.font?.size;return(!t||typeof t=="string")&&(t=0),{start:{y:e.start.y,x:e.start.x},size:{w:e.size.w,h:e.size.h??(e.text.lineHeight??t)*(e.text.lines?.length??0)}}},ne=async(e,t,i)=>{let r=t.illustrator;e.size=await r.calc({layerType:"text",purpose:"size",values:e.size}),e.start=await r.calc({layerType:"text",purpose:"position",values:e.start});let{outlineThickness:o,fontSize:n,gap:a,lineHeight:s}=await r.calc({layerType:"text",purpose:"prepare",values:{fontSize:Y(e),lineHeight:e.text.lineHeight??0,gap:e.text.columns?.gap??0,outlineThickness:e.text.outline?.thickness??0}});e.text.lineHeight&&(e.text.lineHeight=s),e.text.outline?.thickness&&(e.text.outline.thickness=o),e.text.columns=e.text.columns??{amount:1,gap:0},e.text.columns.gap=a,e.text.font=e.text.font??{},e.text.font.size=n,typeof e.text.color?.type=="string"&&await S(r,e.text.color);let{lines:l,lineHeight:u,width:c,columns:g,fontSize:p}=Re(e,i,e.size.w);return e.text.transY=Fe(e.size.h,u,l,e.text.align?.vertical||"top"),ke()&&(e.start.y-=p*.2),e.text.lineHeight=u,e.text.font.size=p,e.text.columns=g,e.size.w=c,e.text.lines=l,e.area=Le(e),e},Re=(e,t,i)=>{let r=e.text.columns??{gap:0,amount:1},o=F(e),{textBaseline:n="top"}=e.text,{value:a}=e.text;t.save(),t.font=G(e,t,String(o)),t.textBaseline=n;let s=Me(i,r);a=Pe(e,a);let l=Ne(e,a,t,s);return t.restore(),{lines:l,fontSize:o,lineHeight:e.text.lineHeight??o,width:s,columns:r}},Ne=(e,t,i,r)=>{if(!e.text.wrap)return[[t,0]];let o=[],n=t.split(/[^\S\r\n]/),a="",s=0;for(;n.length>0;){let l=n[0].search(/[\r\n]/);if(l!==-1){let c=n[0].substring(0,l);o.push([(a+" "+c).trim()+`
`,s]),a="",s++,n[0]=n[0].substring(l+1);continue}i.measureText(a+n[0]).width>r&&(a.length>0&&(o.push([a.trim(),s]),s++),a=""),a+=" "+n[0],n=n.splice(1)}return a.length>0&&o.push([a.replace(/^\s+/,""),s]),o},Pe=(e,t)=>e.text.spacing?t.split("").join(z().repeat(e.text.spacing)):t,Me=(e,t)=>(e-(t.amount-1)*t.gap)/t.amount,ke=()=>/^((?!chrome|android).)*safari/i.test(navigator.userAgent),Fe=(e,t,i,r)=>{if(!e||i.length*t>=e)return 0;let o=e-i.length*t;return r==="center"?o/2:r==="bottom"?o:0};var Ge=async e=>{let t;return e.group.interaction==="static"?t=Oe(e):(t=He(e),t.start.y+=e.start.y,t.start.x+=e.start.x),e.group.clip&&(isNaN(e.size.h)||(t.size.h=e.size.h),isNaN(e.size.w)||(t.size.w=e.size.w)),t},oe=e=>({size:{w:isNaN(e.size.w??NaN)?0:e.size.w,h:isNaN(e.size.h??NaN)?0:e.size.h},start:{x:0,y:0}}),Oe=e=>{let t=oe(e),i=W(e,e.layout);return t.size.h||(t.size.h=O(e,i)),t.size.w||(t.size.w=H(e,i)),t.start.x=e.start.x,t.start.y=e.start.y,t},He=e=>{let t=oe(e),i=!!t.size.w,r=!!t.size.h;for(let o=0;o<e.layout.length;o++){let n=e.layout[o].area;n&&(r||(t.size.h=Math.max(t.size.h,n.size.h+n.start.y)),i||(t.size.w=Math.max(t.size.w,n.size.w+n.start.x)),t.start.y=Math.min(t.start.y,n.start.y),t.start.x=Math.min(t.start.x,n.start.x))}return t.start.y<0&&(t.start.y=0),t.start.x<0&&(t.start.x=0),t},ae=async(e,t,i)=>{let{group:r}=t,o=e.illustrator;t.size=await o.calc({layerType:"group",purpose:"size",values:t.size??{w:0,h:0}}),t.size.w??=NaN,t.size.h??=NaN,t.start=await o.calc({layerType:"group",purpose:"position",values:t.start??{x:0,y:0}}),t.start.y??=0,t.start.x??=0,r.gap=await o.calc({layerType:"group",purpose:"gap",values:r.gap??{vertical:0,horizontal:0}}),r.gap.vertical??=0,r.gap.horizontal??=0;let n=e.core.setting.get("workspace")??{};n.relative??={};let a=n.relative.height,s=n.relative.width;isNaN(t.size.h)||(n.relative.height=t.size.h),isNaN(t.size.w)||(n.relative.width=t.size.w),t.layout=await e.core.view.recalculate(t,t.layout,i),r.interaction??="fixed",n.relative.height=a,n.relative.width=s,t.area=await Ge(t)};var T={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"};var We=()=>({group:{clip:"boolean",interaction:"string",direction:"string",wrap:"boolean",gap:{vertical:"number",horizontal:"number"}}}),se=We;var Ve=()=>({image:{timeout:"number",fit:"string",overcolor:{fill:"string"},outline:{thickness:"number",fill:"string"},align:{vertical:"string",horizontal:"string"},fitTo:"string",src:"string"}}),le=Ve;var Be=()=>({polygon:{steps:[{means:"string",args:{x:"number",y:"number",cp1x:"number",cp1y:"number",cp2x:"number",cp2y:"number",thickness:"number",fill:"string",lineJoin:"string",miterLimit:"number"}}],size:{negative:{x:"number",y:"number"},positive:{x:"number",y:"number"}}}}),ce=Be;var Ue=()=>({text:{value:"string",align:{vertical:"string",horizontal:"string"},columns:{amount:"number",gap:"number"},font:{style:"string",family:"string",weight:"string",size:"string",stretch:"string",variant:"string",height:"string"},spacing:"number",textBaseline:"string",wrap:"boolean",lineHeight:"number",color:"string",outline:{fill:"string",thickness:"number",lineJoin:"string",miterLimit:"number",transY:"number",lines:[["string","number"]]}}}),ue=Ue;var E=class{#e;#t;#i;#r;constructor(t,i,r){if(!t)throw new Error("[Antetype Illustrator] Provided canvas is empty");this.#e=t,this.#t=i,this.#r=r,this.#i=this.#e.getContext("2d"),this.#n()}#n(){let t=this.#r.batch([{event:T.CLOSE,subscription:()=>{t()}},{event:T.DRAW,subscription:async i=>{let{element:r}=i.detail,n={clear:this.clear.bind(this),polygon:this.polygon.bind(this),image:this.image.bind(this),text:this.text.bind(this),group:this.group.bind(this)}[r.type];typeof n=="function"&&await n(r)}},{event:T.CALC,subscription:async i=>{if(i.detail.element===null)return;let{element:r,sessionId:o}=i.detail,a={polygon:this.polygonCalc.bind(this),image:this.imageCalc.bind(this),text:this.textCalc.bind(this),group:this.groupCalc.bind(this)}[r.type];typeof a=="function"&&await a(r,o)}},{event:T.TYPE_DEFINITION,subscription:i=>{let r=i.detail.definitions;r.text=ue(),r.group=se(),r.image=le(),r.polygon=ce()}}])}reset(){this.#e.width+=0}clear(){this.#i.clearRect(0,0,this.#e.width,this.#e.height)}async groupCalc(t,i=null){await ae(this.#t,t,i)}group(t){q(this.#i,this.#t,t)}async polygonCalc(t){t.start=await this.calc({layerType:"polygon",purpose:"position",values:t.start}),t.polygon.size={negative:{x:0,y:0},positive:{x:0,y:0}};for(let i of t.polygon.steps)await J(t,i,this.#t);t.area=K(t)}polygon({polygon:{steps:t},start:{x:i,y:r}}){let o=this.#i;o.save(),o.beginPath(),o.moveTo(i,r);for(let n of t)U(o,n,i,r);o.closePath(),o.restore()}async imageCalc(t){await Z(this.#t,t)}image(t){j(this.#i,t)}async textCalc(t){await ne(t,this.#t,this.#i)}text(t){X(this.#i,t)}async calc(t){let i=new CustomEvent(P.CALC,{detail:t});return await this.#r.dispatch(i),i.detail.values}generateText(t){return{type:"text",start:{x:0,y:0},size:{w:300,h:100},text:{value:t,font:{family:"Arial",weight:400,size:30}}}}generateImage(t){return{type:"image",start:{x:0,y:0},size:{w:300,h:300},image:{src:t}}}generatePolygon(t=[]){return{type:"polygon",start:{x:0,y:0},size:{w:NaN,h:NaN},polygon:{steps:t,size:{negative:{x:0,y:0},positive:{x:0,y:0}}}}}generateGroup(t){let i={type:"group",start:{x:0,y:0},size:{w:NaN,h:NaN},group:{},layout:[]};for(let r of t)r.hierarchy={parent:i,position:i.layout.length},i.layout.push(r);return i}};export{ge as Event,E as Illustrator};

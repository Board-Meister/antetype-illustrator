var ye=(t=>(t.CALC="antetype.illustrator.calc",t))(ye||{});var M=(e=>(e.CALC="antetype.workspace.calc",e))(M||{}),de=(e=>(e.WEBP="image/webp",e.PNG="image/png",e.JPG="image/jpeg",e))(de||{}),R=(e=>(e.CALC="antetype.cursor.calc",e.POSITION="antetype.cursor.position",e.DOWN="antetype.cursor.on.down",e.UP="antetype.cursor.on.up",e.MOVE="antetype.cursor.on.move",e.SLIP="antetype.cursor.on.slip",e.RESIZED="antetype.cursor.on.resized",e))(R||{}),V={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"},fe="core",ve="0.0.5",ct=class{#e;#t=null;#i=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}async loadModules(e,t){return(await this.#a()).loadModules(e,t)}register(e){let{registration:t}=e.detail;t[fe]={load:async()=>(this.#t??=(await this.#r("core.js")).default,(i,r)=>this.#t({canvas:r,modules:i,herald:this.#e.herald})),version:ve}}static subscriptions={[V.MODULES]:"register"};#r(e){return import(this.#e.marshal.getResourceUrl(this,e))}async#a(){return this.#i??=(await this.#r("helper.js")).default,new this.#i(this.#e.herald)}},Ie=(e=>(e.SAVE="antetype.memento.save",e))(Ie||{}),U={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"},we="core",be="0.0.5",ut=class{#e;#t=null;#i=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}async loadModules(e,t){return(await this.#a()).loadModules(e,t)}register(e){let{registration:t}=e.detail;t[we]={load:async()=>(this.#t??=(await this.#r("core.js")).default,(i,r)=>this.#t({canvas:r,modules:i,herald:this.#e.herald})),version:be}}static subscriptions={[U.MODULES]:"register"};#r(e){return import(this.#e.marshal.getResourceUrl(this,e))}async#a(){return this.#i??=(await this.#r("helper.js")).default,new this.#i(this.#e.herald)}},xe="memento",Te="0.0.4",ht=class{#e;#t=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}register(e){let{registration:t}=e.detail;t[xe]={load:async()=>{if(!this.#t){let i=this.#e.marshal.getResourceUrl(this,"module.js");this.#t=(await import(i)).default}return(i,r)=>this.#t({canvas:r,modules:i,herald:this.#e.herald})},version:Te}}static subscriptions={[U.MODULES]:"register"}},Ce="cursor",Se="0.0.5",pt=class{#e;#t=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}register(e){let{registration:t}=e.detail;t[Ce]={load:async()=>{if(!this.#t){let i=this.#e.marshal.getResourceUrl(this,"module.js");this.#t=(await import(i)).default}return(i,r)=>this.#t({canvas:r,modules:i,herald:this.#e.herald})},version:Se}}static subscriptions={[V.MODULES]:"register"}},C={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"},De="core",Ee="0.0.5",gt=class{#e;#t=null;#i=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}async loadModules(e,t){return(await this.#a()).loadModules(e,t)}register(e){let{registration:t}=e.detail;t[De]={load:async()=>(this.#t??=(await this.#r("core.js")).default,(i,r)=>this.#t({canvas:r,modules:i,herald:this.#e.herald})),version:Ee}}static subscriptions={[C.MODULES]:"register"};#r(e){return import(this.#e.marshal.getResourceUrl(this,e))}async#a(){return this.#i??=(await this.#r("helper.js")).default,new this.#i(this.#e.herald)}},mt=class{#canvas;#modules;#herald;#ctx;#translationSet=0;#drawWorkspace=!0;#isExporting=!1;#quality=1;#scale=1;#translate={left:0,top:0};constructor(e,t,i){if(!e)throw new Error("[Antetype Workspace] Provided canvas is empty");this.#canvas=e,this.#updateCanvas(),this.#modules=t,this.#ctx=this.#canvas.getContext("2d"),this.#observeCanvasResize(),this.#herald=i,this.subscribe()}subscribe(){let e=this.#herald.batch([{event:C.CLOSE,subscription:()=>{e()}},{event:"antetype.workspace.calc",subscription:this.calcEventHandle.bind(this)},{event:C.DRAW,subscription:[{method:t=>{let{element:i}=t.detail,r={clear:this.clearCanvas.bind(this),workspace:this.drawWorkspace.bind(this)}[i.type];typeof r=="function"&&r(i)},priority:1},{method:()=>{this.setOrigin()},priority:-255},{method:()=>{this.restore()},priority:255}]},{event:R.POSITION,subscription:t=>{t.detail.x-=this.getLeft(),t.detail.y-=this.getTop()}},{event:R.CALC,subscription:this.calcEventHandle.bind(this)},{event:C.SETTINGS,subscription:t=>{t.detail.settings.push(this.getSettingsDefinition())}},{event:"antetype.conditions.method.register",subscription:t=>{this.handleConditionsMethodRegisterMethod(t)}}])}calcEventHandle(e){let t=e.detail.values,i=Object.keys(t);for(let r of i)t[r]=this.calc(t[r])}#observeCanvasResize(){new ResizeObserver(()=>{!this.#updateCanvas()||!this.#modules.core||this.#modules.core.view.recalculate().then(()=>{this.#modules.core.view.redraw()})}).observe(this.#canvas)}#updateCanvas(){let e=this.#canvas.offsetWidth*this.#quality,t=this.#canvas.offsetHeight*this.#quality,i=Number(this.#canvas.getAttribute("width")),r=Number(this.#canvas.getAttribute("height"));return!t||!e||i===e&&r===t?!1:(this.#canvas.setAttribute("height",String(t)),this.#canvas.setAttribute("width",String(e)),!0)}setTranslateLeft(e){this.#translate.left=e}setTranslateTop(e){this.#translate.top=e}getTranslate(){return this.#translate}setQuality(e){if(isNaN(e))throw new Error("Workspace quality must be a number");this.#quality=Number(e),this.#updateCanvas()}getQuality(){return this.#quality}getScale(){return this.#scale}setScale(e){if(isNaN(e))throw new Error("Workspace scale must be a number");this.#scale=e}scale(e){return e*this.#scale*this.#quality}typeToExt(e){return e=="image/png"?"png":e=="image/jpeg"?"jpg":"webp"}async download(e){let t=document.createElement("a");t.download=e.filename+"."+this.typeToExt(e.type);let i=URL.createObjectURL(await this.export(e));t.href=i,t.click(),URL.revokeObjectURL(i)}#updateQualityBasedOnDpi(e){let t=e*11.692913385826772,i=this.getSize().height/this.#quality;this.setQuality(t/i)}async export({type:e="image/webp",quality:t=.9,dpi:i=300}={}){let r=this.#modules.core.view,s=this.#drawWorkspace;try{this.#drawWorkspace=!1,this.setExporting(!0),this.#updateQualityBasedOnDpi(i),this.#updateCanvas(),await r.recalculate(),r.redraw();let a=await this.#canvasToBlob(e,t);if(!a)throw new Error("Couldn't export canvas workspace");return a}finally{this.#drawWorkspace=s,this.setExporting(!1),this.setQuality(1),this.#updateCanvas(),await r.recalculate(),r.redraw()}}#canvasToBlob(e="image/webp",t=.9){let{width:i,height:r}=this.getSize(),s=this.getTop(),a=this.getLeft(),o=this.#ctx.getImageData(a,s,i,r),n=document.createElement("canvas");return n.width=i,n.height=r,n.getContext("2d").putImageData(o,0,0),new Promise(l=>{let u=setTimeout(()=>{l(null)},3e4);n.toBlob(c=>{clearTimeout(u),l(c)},e,t)})}clearCanvas(){this.#ctx.clearRect(-this.getLeft(),-this.getTop(),this.#canvas.width,this.#canvas.height)}setExporting(e){this.#isExporting=e}isExporting(){return this.#isExporting}drawWorkspace(){if(this.#isExporting)return;let e=this.#ctx;e.save();let{height:t,width:i}=this.getSize();e.fillStyle="#FFF",e.fillRect(0,0,i,t),e.restore()}getLeft(){let e=this.#ctx,{width:t}=this.getSize();return(Number(e.canvas.getAttribute("width"))-t)/2+this.getTranslate().left}getTop(){let e=this.#ctx,{height:t}=this.getSize();return(Number(e.canvas.getAttribute("height"))-t)/2+this.getTranslate().top}setOrigin(){if(this.#translationSet++,this.#translationSet>1)return;let e=this.#ctx;e.save(),e.translate(this.getLeft(),this.getTop())}restore(){this.#translationSet--,this.#translationSet==0&&this.#ctx.restore()}toRelative(e,t="x",i=3){let{height:r,width:s}=this.#getSizeRelative();e=Math.round((e+Number.EPSILON)*10**i)/10**i;let a=e/r*100,o="h%";return t==="x"&&(a=e/s*100,o="w%"),String(Math.round((a+Number.EPSILON)*10**i)/10**i)+o}calc(operation,quiet=!1){if(typeof operation=="number")return this.scale(operation);if(typeof operation!="string"||operation.match(/[^-()\d/*+.pxw%hv ]/g))return console.warn("Calculation contains invalid characters!",operation),NaN;let convertUnitToNumber=(e,t=2)=>Number(e.slice(0,e.length-t)),{height:aHeight,width:aWidth}=this.getSize(),{height,width}=this.#getSizeRelative(),unitsTranslator={px:e=>convertUnitToNumber(e),"w%":e=>convertUnitToNumber(e)/100*width,"h%":e=>convertUnitToNumber(e)/100*height,vh:e=>convertUnitToNumber(e)/100*aHeight,vw:e=>convertUnitToNumber(e)/100*aWidth,default:e=>e},calculation="";operation.split(" ").forEach(e=>{e=e.trim();let t=e[e.length-1],i=e[e.length-2],r=(unitsTranslator[i+t]||unitsTranslator.default)(e);typeof r=="number"&&(r=this.#decimal(r)),calculation+=String(r)});let result;try{result=eval(calculation)}catch(e){result=void 0,quiet||console.warn("Invalid calculation! Tried to calculate from",calculation)}return result==null?NaN:this.#decimal(result)}#decimal(e,t=2){return+e.toFixed(t)}#getSystem(){return this.#modules.core}#getSettings(){let e=this.#ctx.canvas.offsetHeight,t=this.#getSystem().setting.get("workspace")??{};if(isNaN(Number(t.height))&&(t.height=e),isNaN(Number(t.width))){let i=.707070707;t.width=Math.round(e*i)}return t}getSize(){let{width:e,height:t}=this.#getSettings(),i=e/t,r=this.#ctx.canvas.offsetHeight,s=r*i;return s>this.#ctx.canvas.offsetWidth&&(s=this.#ctx.canvas.offsetWidth,r=s/i),{width:this.scale(s),height:this.scale(r)}}#getSizeRelative(){let e=this.#getSettings(),{width:t,height:i}=this.getSize(),r=e.relative?.width??t,s=e.relative?.height??i,a=r/s,o={width:e.relative?.width??0,height:e.relative?.height??0},n=this.#ctx.canvas.offsetHeight;return o.width||(o.width=this.scale(n*a)),o.height||(o.height=this.scale(n)),o.width>this.scale(this.#ctx.canvas.offsetWidth)&&(o.width=this.scale(this.#ctx.canvas.offsetWidth),o.height=this.scale(this.#ctx.canvas.offsetWidth/a)),{width:o.width,height:o.height}}handleConditionsMethodRegisterMethod(e){let{methods:t}=e.detail;t.hideOnExport={name:"Hide on export",type:"hide-export",resolve:({event:i})=>{this.isExporting()&&(i.detail.element=null)}}}getSettingsDefinition(){let e=this.#getSettings();return{details:{label:"Workspace"},name:"workspace",tabs:[{label:"General",fields:[[{label:"Dimensions",type:"container",fields:[[{label:"Height",type:"number",name:"height",value:e.height},{label:"Width",type:"number",name:"width",value:e.width}]]}]]}]}}},Ae="workspace",ze="0.0.4",yt=class{#e=null;#t;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#t=e}register(e){let{registration:t}=e.detail;t[Ae]={load:async()=>{if(!this.#e){let i=this.#t.marshal.getResourceUrl(this,"module.js");this.#e=(await import(i)).default}return(i,r)=>new this.#e(r,i,this.#t.herald)},version:ze}}static subscriptions={[C.MODULES]:"register"}};async function E(e,t){if(t.type==="linear"){let i=t.style;i.pos=await e.calc({layerType:"polygon-fill-linear",purpose:"position",values:i.pos}),i.size=await e.calc({layerType:"polygon-fill-linear",purpose:"size",values:i.size})}return t}function y(e,t){let i={default:r=>r,linear:r=>Le(r.colors,r.pos.x,r.pos.y,r.size.w,r.size.h)};return(i[e]||i.default)(t)}var Le=(e,t,i,r,s)=>{let n=document.createElement("canvas").getContext("2d").createLinearGradient(t,i,r,s);return e.forEach(l=>{n.addColorStop(l.offset,l.color)}),n};var d={line:(e,t,i)=>{e.lineTo(t,i)},curve:(e,t,i,r,s,a,o)=>{e.bezierCurveTo(t,i,r,s,a,o)},stroke:(e,t=5,i="#000",r="round",s=2)=>{e.save(),e.strokeStyle=i,e.lineWidth=t,e.lineJoin=r,e.miterLimit=s,e.stroke(),e.restore()},begin:(e,t,i)=>{e.beginPath(),e.moveTo(t,i)},move:(e,t,i)=>{e.moveTo(t,i)},fill:(e,t)=>{t.type||(t.type="default");let i=e.fillStyle;e.fillStyle=y(t.type,t.style),e.fill(),e.fillStyle=i},close:e=>{e.closePath()},default:(e,t,i)=>d.line(e,t,i)};function _(e,t,i,r){let s={fill:a=>{d.fill(e,a.args)},line:a=>{d.line(e,a.args.x+i,a.args.y+r)},curve:a=>{d.curve(e,a.args.cp1x+i,a.args.cp1y+r,a.args.cp2x+i,a.args.cp2y+r,a.args.x+i,a.args.y+r)},stroke:a=>{d.stroke(e,a.args.thickness??5,a.args.fill??"#000",a.args.lineJoin??"round",a.args.miterLimit??2)},begin:a=>{d.begin(e,a.args.x+i,a.args.y+r)},move:a=>{d.move(e,a.args.x+i,a.args.y+r)},close:()=>d.close(e)};s[t.means]&&s[t.means](t)}var B=Symbol("error"),P=Symbol("timeout"),k=Symbol("loading"),I=class{image;coords;constructor(t,i){this.image=t,this.coords=i}},Y=(e,t)=>{let i=t.image.calculated;if(!i||Ne(i)||Re(i)||!(i instanceof I))return;let{start:{x:r,y:s}}=t.area;e.drawImage(i.image,r+i.coords.xDiff,s+i.coords.yDiff,i.coords.width,i.coords.height)},Ne=e=>e===P,Re=e=>e===k;var X=e=>String(e.text.font?.size??10),F=e=>Number(e.text.font?.size??10),A=()=>"\u200A",K=(e,t)=>{let{x:i}=t.start,r=[],s=0,{start:{y:a},size:{w:o},text:n}=t,{columns:l,transY:u,lineHeight:c}=n,h=[...n.lines],p=Math.ceil(h.length/l.amount),{textBaseline:w="top"}=t.text;for(e.save(),e.font=O(t,e,String(F(t))),e.textBaseline=w;(r=h.splice(0,p)).length;)r.forEach((g,v)=>{let b=r[v+1]||h[0]||[""],x=v+1==r.length||b[0]==""||g[0][g[0].length-1]==`
`,T=u+(g[1]-s)*c;Me(e,g[0],t,i,a,o,T,x)}),s+=r[r.length-1][1]+1,i+=l.gap+o;e.restore()},Me=(e,t,i,r,s,a,o,n)=>{let{color:l="#000",outline:u=null}=i.text,c=i.text.align?.horizontal||"left";c!="left"&&({text:t,x:r}=ke(e,c,t,a,n,r)),o>0&&(s=s+o),e.fillStyle=typeof l=="object"?y(l.type,l.style):l,u&&Pe(e,u,t,r,s,a),e.fillText(t,r,s,a)},Pe=(e,t,i,r,s,a)=>{t.fill?.style&&(e.strokeStyle=y(t.fill.type,t.fill.style),e.lineWidth=t.thickness,e.lineJoin=t.lineJoin??"round",e.miterLimit=t.miterLimit??2,e.strokeText(i,r,s,a))},ke=(e,t,i,r,s,a)=>{let o=e.measureText(i),n=o.width;if(t=="center"){let l=(r-n)/2;l>0&&(a=a+l)}else t=="right"?a=a+r-n:t=="justify"&&!s&&(i=Fe(i,o,r,e));return{text:i,x:a}},Fe=(e,t,i,r)=>{if(t.width>=i)return e;let s=e.split(" "),a=r.measureText(A()),o=Math.floor((i-t.width)/a.width),n=o/(s.length-1);for(let l=0;l<s.length-1;l++)s[l]+=A().repeat(n);return s.join(" ")},O=(e,t,i)=>{let{font:r=null}=e.text;if(!r)return t.font;i=i+"px ";let s=(r.family||"serif")+" ",a=(r.weight??100)+" ",o="";return r.style&&(o+=r.style+" "),r.variant&&(o+=r.variant+" "),o+=a,r.stretch&&(o+=r.stretch+" "),o+=i,r.height&&(o+="/"+r.height+" "),o+s};var q=(e,t,i)=>{let{group:r,start:s}=i;i.layout.length!==0&&(e.save(),e.translate(s.x,s.y),r.interaction==="fixed"?t.core.view.redraw(i.layout):Oe(e,t,i),e.restore())},G=(e,t)=>{let i=0,r=e.group.gap.horizontal;return t.forEach(s=>{i+=s.height+r}),i-r},H=(e,t)=>{let i=0,r=e.group.gap.vertical;return t.forEach(s=>{e.group.direction==="column"?i=Math.max(i,s.width):i+=s.width+r}),e.group.direction==="row"&&(i-=r),i},Oe=(e,t,i)=>{let{group:r}=i,{vertical:s,horizontal:a}=r.gap,o=j(i,i.layout);r.clip&&(!isNaN(i.size?.w)||!isNaN(i.size?.h))&&(e.beginPath(),e.rect(0,0,isNaN(i.size.w)?H(i,o):i.size.w,isNaN(i.size.h)?G(i,o):i.size.h),e.clip());let n=0,l=0;o.forEach(u=>{u.layers.forEach(c=>{c.def.start.x=l,c.def.start.y=n,c.def.area&&(c.def.area.start.x=l,c.def.area.start.y=n),t.core.view.draw(c.def),l+=c.def.size.w+s}),l=0,n+=u.height+a})},j=(e,t)=>{let{size:i}=e,r=[],s=()=>({height:0,width:0,layers:[]}),a=s();return t.forEach((o,n)=>{(e.group.wrap&&i.w!=0&&a.width+o.size.w>i.w||n!=0&&e.group.direction==="column")&&(r.push(a),a=s()),a.layers.push({x:a.width,def:o}),a.height<o.size.h&&(a.height=o.size.h),a.width+=o.size.w+e.group.gap.vertical}),r.push(a),r};var J=e=>{let t=e.polygon.size;return{start:{x:e.start.x+t.negative.x,y:e.start.y+t.negative.y},size:{w:t.positive.x-t.negative.x,h:t.positive.y-t.negative.y}}},Q=async(e,t,i)=>{let r=i.illustrator,s={close:()=>{},fill:async a=>{await E(r,a.args)},line:async a=>{a.args=await r.calc({layerType:"polygon-line",purpose:"position",values:a.args}),m(e,a.args.x,"x"),m(e,a.args.y,"y")},curve:async a=>{a.args=await r.calc({layerType:"polygon-curve",purpose:"position",values:a.args}),m(e,a.args.x,"x"),m(e,a.args.cp1x,"x"),m(e,a.args.cp2x,"x"),m(e,a.args.y,"y"),m(e,a.args.cp2y,"y")},stroke:async a=>{a.args.thickness=(await r.calc({layerType:"polygon-stroke",purpose:"thickness",values:{thickness:a.args.thickness??5}})).thickness},begin:async a=>{a.args=await r.calc({layerType:"polygon-begin",purpose:"position",values:a.args}),m(e,a.args.x,"x"),m(e,a.args.y,"y")},move:async a=>{a.args=await r.calc({layerType:"polygon-move",purpose:"position",values:a.args})}};t.means||(t.means="line"),s[t.means]&&await s[t.means](t)},m=(e,t,i)=>{if(t<0){let r=e.polygon.size.negative;r[i]=Math.min(r[i],t)}else{let r=e.polygon.size.positive;r[i]=Math.max(r[i],t)}};var Ge={},Z={},He=e=>({start:{x:e.start.x,y:e.start.y},size:{h:e.size.h,w:e.size.w}}),$=async(e,t)=>{let i=e.illustrator;t.size=await i.calc({layerType:"image",purpose:"size",values:t.size}),t.start=await i.calc({layerType:"image",purpose:"position",values:t.start}),t.area=He(t),t.image?.outline?.thickness&&(t.image.outline.thickness=(await i.calc({layerType:"image",purpose:"thickness",values:{thickness:t.image.outline.thickness}})).thickness);let r=te(t.image),s=Z[r];if(s){t.image.calculated=je(t,s);return}if(t.image.src instanceof Image){t.image.calculated=await ee(t,t.image.src,e,r);return}if(typeof t.image.src!="string")return;let a=t.image.src;if(typeof a!="string"||!a.startsWith("blob:http")&&!a.startsWith("http")&&!a.startsWith("/")){console.warn("Image `"+a+"` has invalid source");return}let o=e.core.setting.get("illustrator.image.waitForLoad"),n=We(t,a,e);o&&await n},je=(e,t)=>{let i=e.image,{w:r,h:s}=e.size,{width:a,height:o}=ie(i.fit??"default",t.width,t.height,r,s),n=ae(i.align?.horizontal??"center",r,a),l=re(i.align?.vertical??"center",s,o);return new I(t.image,{xDiff:n,yDiff:l,width:a,height:o})},ee=async(e,t,i,r=null)=>{let s=e.image,{w:a,h:o}=e.size,n=t.width||200,l=t.height||200,{width:u,height:c}=ie(s.fit??"default",n,l,a,o),h=ae(s.align?.horizontal??"center",a,u),p=re(s.align?.vertical??"center",o,c);return s.fit==="crop"&&(t=await _e(t,e)),s.overcolor&&(t=await Ve(t,e,u,c)),s.outline&&(t=await Ue(t,e,u,c)),Z[r??te(e.image)]={image:t,width:n,height:l},new I(t,{xDiff:h,yDiff:p,width:u,height:c})},te=e=>JSON.stringify({...e,timeout:void 0,calculated:void 0}),We=async(e,t,i)=>{let r=new Image,{image:{timeout:s=3e4}}=e,a=i.core.view;r.crossOrigin="anonymous",r.src=t;let o=new Promise((n,l)=>{let u=setTimeout(()=>{e.image.calculated=P,l(new Error("Image loading reached a timeout: "+t))},s);r.onerror=c=>{clearTimeout(u),e.image.calculated=B,l(c)},r.onload=async()=>{clearTimeout(u),e.image.calculated=await ee(e,r,i),a.redrawDebounce(),n()}});Ge[t]=k,await o},Ve=async(e,t,i,r)=>{let s=document.createElement("canvas"),a=s.getContext("2d"),o=t.image.overcolor;s.setAttribute("width",String(i)),s.setAttribute("height",String(r)),a.drawImage(e,0,0,i,r),a.globalCompositeOperation="source-in",a.fillStyle=y(o.fill.type,o.fill.style),a.fillRect(0,0,s.width,s.height),a.globalCompositeOperation="source-over";let n=await z(s,e);return a.drawImage(n,0,0,i,r),z(s,n)},Ue=async(e,t,i,r)=>{let s=document.createElement("canvas"),a=s.getContext("2d"),o=t.image.outline;if(!o.thickness||!o.fill)return e;let n=o.thickness,l=[[-.75,-.75],[0,-1],[.75,-.75],[1,0],[.75,.75],[0,1],[-.75,.75],[-1,0]];if(n>5){let u=Math.floor(n/2.5),c=[];for(let h=0;h<l.length;h++){c.push(l[h]);let[p,w]=l[h],[g,v]=h+1===l.length?l[0]:l[h+1],b=p>g?-1:1,x=w>v?-1:1,T=Math.abs(p-g)/u*b,N=Math.abs(w-v)/u*x,W=[],S=p,D=w;for(;(b>0&&S+T<g||b<0&&S+T>g)&&(x>0&&D+N<v||x<0&&D+N>v);)S+=T,D+=N,W.push([S,D]);c=c.concat(W)}l=c}s.setAttribute("width",String(i+n*2)),s.setAttribute("height",String(r+n*2));for(let u=0;u<l.length&&(a.drawImage(e,n+l[u][0]*n,n+l[u][1]*n,i,r),n!==0);u++);return a.globalCompositeOperation="source-in",a.fillStyle=y(o.fill.type,o.fill.style),a.fillRect(0,0,s.width,s.height),a.globalCompositeOperation="source-over",a.drawImage(e,n,n,i,r),z(s,e)},z=async(e,t)=>{let i=new Image;return i.src=e.toDataURL("image/webp"),new Promise(r=>{let s=setTimeout(()=>{r(t)},1e3);i.onerror=()=>{clearTimeout(s),r(t)},i.onload=()=>{clearTimeout(s),r(i)}})},_e=async(e,t)=>{let{w:i,h:r}=t.size,s=t.image.fitTo??"auto",a=0,o=0;s==="auto"&&(s=r>i?"height":"width"),s==="height"?a=(i-e.width*(r/e.height))/2:s==="width"&&(o=(r-e.height*(i/e.width))/2);let n=document.createElement("canvas"),l=n.getContext("2d");return n.setAttribute("width",String(i)),n.setAttribute("height",String(r)),l.drawImage(e,a,o,i-a*2,r-o*2),z(n,e)},ie=(e,t,i,r,s)=>e==="stretch"||e==="crop"?{width:r,height:s}:Be(t,i,r,s),Be=(e,t,i,r)=>{let s=Math.min(i/e,r/t),a=e*s,o=t*s;return{width:a,height:o}},re=(e,t,i)=>e=="top"?0:e=="bottom"?t-i:(t-i)/2,ae=(e,t,i)=>e=="left"?0:e=="right"?t-i:(t-i)/2;var Ye=e=>{let t=e.text.font?.size;return(!t||typeof t=="string")&&(t=0),{start:{y:e.start.y,x:e.start.x},size:{w:e.size.w,h:e.size.h??(e.text.lineHeight??t)*(e.text.lines?.length??0)}}},se=async(e,t,i)=>{let r=t.illustrator;e.size=await r.calc({layerType:"text",purpose:"size",values:e.size}),e.start=await r.calc({layerType:"text",purpose:"position",values:e.start});let{outlineThickness:s,fontSize:a,gap:o,lineHeight:n}=await r.calc({layerType:"text",purpose:"prepare",values:{fontSize:X(e),lineHeight:e.text.lineHeight??0,gap:e.text.columns?.gap??0,outlineThickness:e.text.outline?.thickness??0}});e.text.lineHeight&&(e.text.lineHeight=n),e.text.outline?.thickness&&(e.text.outline.thickness=s),e.text.columns=e.text.columns??{amount:1,gap:0},e.text.columns.gap=o,e.text.font=e.text.font??{},e.text.font.size=a,typeof e.text.color?.type=="string"&&await E(r,e.text.color);let{lines:l,lineHeight:u,width:c,columns:h,fontSize:p}=Xe(e,i,e.size.w);return e.text.transY=Ze(e.size.h,u,l,e.text.align?.vertical||"top"),Qe()&&(e.start.y-=p*.2),e.text.lineHeight=u,e.text.font.size=p,e.text.columns=h,e.size.w=c,e.text.lines=l,e.area=Ye(e),e},Xe=(e,t,i)=>{let r=e.text.columns??{gap:0,amount:1},s=F(e),{textBaseline:a="top"}=e.text,{value:o}=e.text;t.save(),t.font=O(e,t,String(s)),t.textBaseline=a;let n=Je(i,r);o=qe(e,o);let l=Ke(e,o,t,n);return t.restore(),{lines:l,fontSize:s,lineHeight:e.text.lineHeight??s,width:n,columns:r}},Ke=(e,t,i,r)=>{if(!e.text.wrap)return[[t,0]];let s=[],a=t.split(/[^\S\r\n]/),o="",n=0;for(;a.length>0;){let l=a[0].search(/[\r\n]/);if(l!==-1){let c=a[0].substring(0,l);s.push([(o+" "+c).trim()+`
`,n]),o="",n++,a[0]=a[0].substring(l+1);continue}i.measureText(o+a[0]).width>r&&(o.length>0&&(s.push([o.trim(),n]),n++),o=""),o+=" "+a[0],a=a.splice(1)}return o.length>0&&s.push([o.replace(/^\s+/,""),n]),s},qe=(e,t)=>e.text.spacing?t.split("").join(A().repeat(e.text.spacing)):t,Je=(e,t)=>(e-(t.amount-1)*t.gap)/t.amount,Qe=()=>/^((?!chrome|android).)*safari/i.test(navigator.userAgent),Ze=(e,t,i,r)=>{if(!e||i.length*t>=e)return 0;let s=e-i.length*t;return r==="center"?s/2:r==="bottom"?s:0};var $e=async e=>{let t;return e.group.interaction==="static"?t=et(e):(t=tt(e),t.start.y+=e.start.y,t.start.x+=e.start.x),e.group.clip&&(isNaN(e.size.h)||(t.size.h=e.size.h),isNaN(e.size.w)||(t.size.w=e.size.w)),t},oe=e=>({size:{w:isNaN(e.size.w??NaN)?0:e.size.w,h:isNaN(e.size.h??NaN)?0:e.size.h},start:{x:0,y:0}}),et=e=>{let t=oe(e),i=j(e,e.layout);return t.size.h||(t.size.h=G(e,i)),t.size.w||(t.size.w=H(e,i)),t.start.x=e.start.x,t.start.y=e.start.y,t},tt=e=>{let t=oe(e),i=!!t.size.w,r=!!t.size.h;for(let s=0;s<e.layout.length;s++){let a=e.layout[s].area;a&&(r||(t.size.h=Math.max(t.size.h,a.size.h+a.start.y)),i||(t.size.w=Math.max(t.size.w,a.size.w+a.start.x)),t.start.y=Math.min(t.start.y,a.start.y),t.start.x=Math.min(t.start.x,a.start.x))}return t.start.y<0&&(t.start.y=0),t.start.x<0&&(t.start.x=0),t},ne=async(e,t,i)=>{let{group:r}=t,s=e.illustrator;t.size=await s.calc({layerType:"group",purpose:"size",values:t.size??{w:0,h:0}}),t.size.w??=NaN,t.size.h??=NaN,t.start=await s.calc({layerType:"group",purpose:"position",values:t.start??{x:0,y:0}}),t.start.y??=0,t.start.x??=0,r.gap=await s.calc({layerType:"group",purpose:"gap",values:r.gap??{vertical:0,horizontal:0}}),r.gap.vertical??=0,r.gap.horizontal??=0;let a=e.core.setting.get("workspace")??{};a.relative??={};let o=a.relative.height,n=a.relative.width;isNaN(t.size.h)||(a.relative.height=t.size.h),isNaN(t.size.w)||(a.relative.width=t.size.w),t.layout=await e.core.view.recalculate(t,t.layout,i),r.interaction??="fixed",a.relative.height=o,a.relative.width=n,t.area=await $e(t)};var f={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded",CANVAS_CHANGE:"antetype.canvas.change"};var it="core",rt="0.0.5",Vt=class{#e;#t=null;#i=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}async loadModules(e){return(await this.#a()).loadModules(e)}register(e){let{registration:t}=e.detail;t[it]={load:async()=>(this.#t??=(await this.#r("core.js")).default,i=>this.#t({modules:i,herald:this.#e.herald})),version:rt}}static subscriptions={[f.MODULES]:"register"};#r(e){return import(this.#e.marshal.getResourceUrl(this,e))}async#a(){return this.#i??=(await this.#r("helper.js")).default,new this.#i(this.#e.herald)}};var at=()=>({group:{clip:"boolean",interaction:"string",direction:"string",wrap:"boolean",gap:{vertical:"number",horizontal:"number"}}}),le=at;var st=()=>({image:{timeout:"number",fit:"string",overcolor:{fill:"string"},outline:{thickness:"number",fill:"string"},align:{vertical:"string",horizontal:"string"},fitTo:"string",src:"string"}}),ce=st;var ot=()=>({polygon:{steps:[{means:"string",args:{x:"number",y:"number",cp1x:"number",cp1y:"number",cp2x:"number",cp2y:"number",thickness:"number",fill:"string",lineJoin:"string",miterLimit:"number"}}],size:{negative:{x:"number",y:"number"},positive:{x:"number",y:"number"}}}}),ue=ot;var nt=()=>({text:{value:"string",align:{vertical:"string",horizontal:"string"},columns:{amount:"number",gap:"number"},font:{style:"string",family:"string",weight:"string",size:"string",stretch:"string",variant:"string",height:"string"},spacing:"number",textBaseline:"string",wrap:"boolean",lineHeight:"number",color:"string",outline:{fill:"string",thickness:"number",lineJoin:"string",miterLimit:"number",transY:"number",lines:[["string","number"]]}}}),he=nt;var L=class{#e;#t;constructor(t,i){this.#e=t,this.#t=i,this.#r()}#i(){let t=this.#e.core.meta.getCanvas();if(!t)throw new Error("[Antetype Illustrator] Provided canvas is empty");return t.getContext("2d")}#r(){let t=this.#t.batch([{event:f.CLOSE,subscription:()=>{t()}},{event:f.DRAW,subscription:async i=>{let{element:r}=i.detail,a={clear:this.clear.bind(this),polygon:this.polygon.bind(this),image:this.image.bind(this),text:this.text.bind(this),group:this.group.bind(this)}[r.type];typeof a=="function"&&await a(r)}},{event:f.CALC,subscription:async i=>{if(i.detail.element===null)return;let{element:r,sessionId:s}=i.detail,o={polygon:this.polygonCalc.bind(this),image:this.imageCalc.bind(this),text:this.textCalc.bind(this),group:this.groupCalc.bind(this)}[r.type];typeof o=="function"&&await o(r,s)}},{event:f.TYPE_DEFINITION,subscription:i=>{let r=i.detail.definitions;r.text=he(),r.group=le(),r.image=ce(),r.polygon=ue()}}])}reset(){this.#i().canvas.width+=0}clear(){this.#i().clearRect(0,0,this.#i().canvas.width,this.#i().canvas.height)}async groupCalc(t,i=null){await ne(this.#e,t,i)}group(t){q(this.#i(),this.#e,t)}async polygonCalc(t){t.start=await this.calc({layerType:"polygon",purpose:"position",values:t.start}),t.polygon.size={negative:{x:0,y:0},positive:{x:0,y:0}};for(let i of t.polygon.steps)await Q(t,i,this.#e);t.area=J(t)}polygon({polygon:{steps:t},start:{x:i,y:r}}){let s=this.#i();s.save(),s.beginPath(),s.moveTo(i,r);for(let a of t)_(s,a,i,r);s.closePath(),s.restore()}async imageCalc(t){await $(this.#e,t)}image(t){Y(this.#i(),t)}async textCalc(t){await se(t,this.#e,this.#i())}text(t){K(this.#i(),t)}async calc(t){let i=new CustomEvent(M.CALC,{detail:t});return await this.#t.dispatch(i),i.detail.values}generateText(t){return{type:"text",start:{x:0,y:0},size:{w:300,h:100},text:{value:t,font:{family:"Arial",weight:400,size:30}}}}generateImage(t){return{type:"image",start:{x:0,y:0},size:{w:300,h:300},image:{src:t}}}generatePolygon(t=[]){return{type:"polygon",start:{x:0,y:0},size:{w:NaN,h:NaN},polygon:{steps:t,size:{negative:{x:0,y:0},positive:{x:0,y:0}}}}}generateGroup(t){let i={type:"group",start:{x:0,y:0},size:{w:NaN,h:NaN},group:{},layout:[]};for(let r of t)r.hierarchy={parent:i,position:i.layout.length},i.layout.push(r);return i}};var ge="illustrator",me="0.0.4",pe=class{#e=null;#t;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(t){this.#t=t}register(t){let{registration:i}=t.detail;i[ge]={load:async()=>{if(!this.#e){let r=this.#t.marshal.getResourceUrl(this,"module.js");this.#e=(await import(r)).default}return r=>new this.#e(r,this.#t.herald)},version:me}}static subscriptions={[f.MODULES]:"register"}};export{ye as Event,ge as ID,L as Illustrator,me as VERSION};

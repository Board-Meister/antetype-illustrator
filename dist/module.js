var N=(e=>(e.CALC="antetype.workspace.calc",e))(N||{}),ge=(e=>(e.WEBP="image/webp",e.PNG="image/png",e.JPG="image/jpeg",e))(ge||{}),R=(e=>(e.CALC="antetype.cursor.calc",e.POSITION="antetype.cursor.position",e.DOWN="antetype.cursor.on.down",e.UP="antetype.cursor.on.up",e.MOVE="antetype.cursor.on.move",e.SLIP="antetype.cursor.on.slip",e.RESIZED="antetype.cursor.on.resized",e))(R||{}),B={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"},Ue=class{#e;#t=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(e){this.#e=e}async#i(e,t){let i=this.#e.minstrel.getResourceUrl(this,"core.js");return this.#t=(await import(i)).default,this.#t({canvas:t,modules:e,herald:this.#e.herald})}async register(e){let{modules:t,canvas:i}=e.detail;t.core=await this.#i(t,i)}static subscriptions={[B.MODULES]:"register"}},he=(e=>(e.SAVE="antetype.memento.save",e))(he||{}),_e=class{#e;#t=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(e){this.#e=e}async register(e){let{modules:t,canvas:i}=e.detail;if(!this.#t){let r=this.#e.minstrel.getResourceUrl(this,"module.js");this.#t=(await import(r)).default}t.memento=this.#t({canvas:i,modules:t,herald:this.#e.herald})}static subscriptions={[B.MODULES]:"register"}},L={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"},je=class{#canvas;#modules;#herald;#ctx;#translationSet=0;#drawWorkspace=!0;#isExporting=!1;#quality=1;#scale=1;#translate={left:0,top:0};constructor(e,t,i){if(!e)throw new Error("[Antetype Workspace] Provided canvas is empty");this.#canvas=e,this.#updateCanvas(),this.#modules=t,this.#ctx=this.#canvas.getContext("2d"),this.#observeCanvasResize(),this.#herald=i,this.subscribe()}subscribe(){let e=this.#herald.batch([{event:L.CLOSE,subscription:()=>{e()}},{event:"antetype.workspace.calc",subscription:this.calcEventHandle.bind(this)},{event:L.DRAW,subscription:[{method:t=>{let{element:i}=t.detail,r={clear:this.clearCanvas.bind(this),workspace:this.drawWorkspace.bind(this)}[i.type];typeof r=="function"&&r(i)},priority:1},{method:()=>{this.setOrigin()},priority:-255},{method:()=>{this.restore()},priority:255}]},{event:R.POSITION,subscription:t=>{t.detail.x-=this.getLeft(),t.detail.y-=this.getTop()}},{event:R.CALC,subscription:this.calcEventHandle.bind(this)},{event:L.SETTINGS,subscription:t=>{t.detail.settings.push(this.getSettingsDefinition())}},{event:"antetype.conditions.method.register",subscription:t=>{this.handleConditionsMethodRegisterMethod(t)}}])}calcEventHandle(e){let t=e.detail.values,i=Object.keys(t);for(let r of i)t[r]=this.calc(t[r])}#observeCanvasResize(){new ResizeObserver(()=>{!this.#updateCanvas()||!this.#modules.core||this.#modules.core.view.recalculate().then(()=>{this.#modules.core.view.redraw()})}).observe(this.#canvas)}#updateCanvas(){let e=this.#canvas.offsetWidth*this.#quality,t=this.#canvas.offsetHeight*this.#quality,i=Number(this.#canvas.getAttribute("width")),r=Number(this.#canvas.getAttribute("height"));return!t||!e||i===e&&r===t?!1:(this.#canvas.setAttribute("height",String(t)),this.#canvas.setAttribute("width",String(e)),!0)}setTranslateLeft(e){this.#translate.left=e}setTranslateTop(e){this.#translate.top=e}getTranslate(){return this.#translate}setQuality(e){if(isNaN(e))throw new Error("Workspace quality must be a number");this.#quality=Number(e),this.#updateCanvas()}getQuality(){return this.#quality}getScale(){return this.#scale}setScale(e){if(isNaN(e))throw new Error("Workspace scale must be a number");this.#scale=e}scale(e){return e*this.#scale*this.#quality}typeToExt(e){return e=="image/png"?"png":e=="image/jpeg"?"jpg":"webp"}async download(e){let t=document.createElement("a");t.download=e.filename+"."+this.typeToExt(e.type);let i=URL.createObjectURL(await this.export(e));t.href=i,t.click(),URL.revokeObjectURL(i)}#updateQualityBasedOnDpi(e){let t=e*11.692913385826772,i=this.getSize().height/this.#quality;this.setQuality(t/i)}async export({type:e="image/webp",quality:t=.9,dpi:i=300}={}){let r=this.#modules.core.view,a=this.#drawWorkspace;try{this.#drawWorkspace=!1,this.setExporting(!0),this.#updateQualityBasedOnDpi(i),this.#updateCanvas(),await r.recalculate(),r.redraw();let n=await this.#canvasToBlob(e,t);if(!n)throw new Error("Couldn't export canvas workspace");return n}finally{this.#drawWorkspace=a,this.setExporting(!1),this.setQuality(1),this.#updateCanvas(),await r.recalculate(),r.redraw()}}#canvasToBlob(e="image/webp",t=.9){let{width:i,height:r}=this.getSize(),a=this.getTop(),n=this.getLeft(),o=this.#ctx.getImageData(n,a,i,r),s=document.createElement("canvas");return s.width=i,s.height=r,s.getContext("2d").putImageData(o,0,0),new Promise(l=>{let u=setTimeout(()=>{l(null)},3e4);s.toBlob(c=>{clearTimeout(u),l(c)},e,t)})}clearCanvas(){this.#ctx.clearRect(-this.getLeft(),-this.getTop(),this.#canvas.width,this.#canvas.height)}setExporting(e){this.#isExporting=e}isExporting(){return this.#isExporting}drawWorkspace(){if(this.#isExporting)return;let e=this.#ctx;e.save();let{height:t,width:i}=this.getSize();e.fillStyle="#FFF",e.fillRect(0,0,i,t),e.restore()}getLeft(){let e=this.#ctx,{width:t}=this.getSize();return(Number(e.canvas.getAttribute("width"))-t)/2+this.getTranslate().left}getTop(){let e=this.#ctx,{height:t}=this.getSize();return(Number(e.canvas.getAttribute("height"))-t)/2+this.getTranslate().top}setOrigin(){if(this.#translationSet++,this.#translationSet>1)return;let e=this.#ctx;e.save(),e.translate(this.getLeft(),this.getTop())}restore(){this.#translationSet--,this.#translationSet==0&&this.#ctx.restore()}toRelative(e,t="x",i=3){let{height:r,width:a}=this.#getSizeRelative();e=Math.round((e+Number.EPSILON)*10**i)/10**i;let n=e/r*100,o="h%";return t==="x"&&(n=e/a*100,o="w%"),String(Math.round((n+Number.EPSILON)*10**i)/10**i)+o}calc(operation,quiet=!1){if(typeof operation=="number")return this.scale(operation);if(typeof operation!="string"||operation.match(/[^-()\d/*+.pxw%hv ]/g))return console.warn("Calculation contains invalid characters!",operation),NaN;let convertUnitToNumber=(e,t=2)=>Number(e.slice(0,e.length-t)),{height:aHeight,width:aWidth}=this.getSize(),{height,width}=this.#getSizeRelative(),unitsTranslator={px:e=>convertUnitToNumber(e),"w%":e=>convertUnitToNumber(e)/100*width,"h%":e=>convertUnitToNumber(e)/100*height,vh:e=>convertUnitToNumber(e)/100*aHeight,vw:e=>convertUnitToNumber(e)/100*aWidth,default:e=>e},calculation="";operation.split(" ").forEach(e=>{e=e.trim();let t=e[e.length-1],i=e[e.length-2],r=(unitsTranslator[i+t]||unitsTranslator.default)(e);typeof r=="number"&&(r=this.#decimal(r)),calculation+=String(r)});let result;try{result=eval(calculation)}catch(e){result=void 0,quiet||console.warn("Invalid calculation! Tried to calculate from",calculation)}return result==null?NaN:this.#decimal(result)}#decimal(e,t=2){return+e.toFixed(t)}#getSystem(){return this.#modules.core}#getSettings(){let e=this.#ctx.canvas.offsetHeight,t=this.#getSystem().setting.get("workspace")??{};if(isNaN(Number(t.height))&&(t.height=e),isNaN(Number(t.width))){let i=.707070707;t.width=Math.round(e*i)}return t}getSize(){let{width:e,height:t}=this.#getSettings(),i=e/t,r=this.#ctx.canvas.offsetHeight,a=r*i;return a>this.#ctx.canvas.offsetWidth&&(a=this.#ctx.canvas.offsetWidth,r=a/i),{width:this.scale(a),height:this.scale(r)}}#getSizeRelative(){let e=this.#getSettings(),{width:t,height:i}=this.getSize(),r=e.relative?.width??t,a=e.relative?.height??i,n=r/a,o={width:e.relative?.width??0,height:e.relative?.height??0},s=this.#ctx.canvas.offsetHeight;return o.width||(o.width=this.scale(s*n)),o.height||(o.height=this.scale(s)),o.width>this.scale(this.#ctx.canvas.offsetWidth)&&(o.width=this.scale(this.#ctx.canvas.offsetWidth),o.height=this.scale(this.#ctx.canvas.offsetWidth/n)),{width:o.width,height:o.height}}handleConditionsMethodRegisterMethod(e){let{methods:t}=e.detail;t.hideOnExport={name:"Hide on export",type:"hide-export",resolve:({event:i})=>{this.isExporting()&&(i.detail.element=null)}}}getSettingsDefinition(){let e=this.#getSettings();return{details:{label:"Workspace"},name:"workspace",tabs:[{label:"General",fields:[[{label:"Dimensions",type:"container",fields:[[{label:"Height",type:"number",name:"height",value:e.height},{label:"Width",type:"number",name:"width",value:e.width}]]}]]}]}}};async function S(e,t){if(t.type==="linear"){let i=t.style;i.pos=await e.calc({layerType:"polygon-fill-linear",purpose:"position",values:i.pos}),i.size=await e.calc({layerType:"polygon-fill-linear",purpose:"size",values:i.size})}return t}function y(e,t){let i={default:r=>r,linear:r=>pe(r.colors,r.pos.x,r.pos.y,r.size.w,r.size.h)};return(i[e]||i.default)(t)}var pe=(e,t,i,r,a)=>{let s=document.createElement("canvas").getContext("2d").createLinearGradient(t,i,r,a);return e.forEach(l=>{s.addColorStop(l.offset,l.color)}),s};var d={line:(e,t,i)=>{e.lineTo(t,i)},curve:(e,t,i,r,a,n,o)=>{e.bezierCurveTo(t,i,r,a,n,o)},stroke:(e,t=5,i="#000",r="round",a=2)=>{e.save(),e.strokeStyle=i,e.lineWidth=t,e.lineJoin=r,e.miterLimit=a,e.stroke(),e.restore()},begin:(e,t,i)=>{e.beginPath(),e.moveTo(t,i)},move:(e,t,i)=>{e.moveTo(t,i)},fill:(e,t)=>{t.type||(t.type="default");let i=e.fillStyle;e.fillStyle=y(t.type,t.style),e.fill(),e.fillStyle=i},close:e=>{e.closePath()},default:(e,t,i)=>d.line(e,t,i)};function U(e,t,i,r){let a={fill:n=>{d.fill(e,n.args)},line:n=>{d.line(e,n.args.x+i,n.args.y+r)},curve:n=>{d.curve(e,n.args.cp1x+i,n.args.cp1y+r,n.args.cp2x+i,n.args.cp2y+r,n.args.x+i,n.args.y+r)},stroke:n=>{d.stroke(e,n.args.thickness??5,n.args.fill??"#000",n.args.lineJoin??"round",n.args.miterLimit??2)},begin:n=>{d.begin(e,n.args.x+i,n.args.y+r)},move:n=>{d.move(e,n.args.x+i,n.args.y+r)},close:()=>d.close(e)};a[t.means]&&a[t.means](t)}var _=Symbol("error"),P=Symbol("timeout"),M=Symbol("loading"),v=class{image;coords;constructor(t,i){this.image=t,this.coords=i}},j=(e,t)=>{let i=t.image.calculated;if(!i||me(i)||ye(i)||!(i instanceof v))return;let{start:{x:r,y:a}}=t.area;e.drawImage(i.image,r+i.coords.xDiff,a+i.coords.yDiff,i.coords.width,i.coords.height)},me=e=>e===P,ye=e=>e===M;var Y=e=>String(e.text.font?.size??10),k=e=>Number(e.text.font?.size??10),z=()=>"\u200A",X=(e,t)=>{let{x:i}=t.start,r=[],a=0,{start:{y:n},size:{w:o},text:s}=t,{columns:l,transY:u,lineHeight:c}=s,g=[...s.lines],h=Math.ceil(g.length/l.amount),{textBaseline:I="top"}=t.text;for(e.save(),e.font=F(t,e,String(k(t))),e.textBaseline=I;(r=g.splice(0,h)).length;)r.forEach((p,f)=>{let w=r[f+1]||g[0]||[""],b=f+1==r.length||w[0]==""||p[0][p[0].length-1]==`
`,x=u+(p[1]-a)*c;de(e,p[0],t,i,n,o,x,b)}),a+=r[r.length-1][1]+1,i+=l.gap+o;e.restore()},de=(e,t,i,r,a,n,o,s)=>{let{color:l="#000",outline:u=null}=i.text,c=i.text.align?.horizontal||"left";c!="left"&&({text:t,x:r}=ve(e,c,t,n,s,r)),o>0&&(a=a+o),e.fillStyle=typeof l=="object"?y(l.type,l.style):l,u&&fe(e,u,t,r,a,n),e.fillText(t,r,a,n)},fe=(e,t,i,r,a,n)=>{t.fill?.style&&(e.strokeStyle=y(t.fill.type,t.fill.style),e.lineWidth=t.thickness,e.lineJoin=t.lineJoin??"round",e.miterLimit=t.miterLimit??2,e.strokeText(i,r,a,n))},ve=(e,t,i,r,a,n)=>{let o=e.measureText(i),s=o.width;if(t=="center"){let l=(r-s)/2;l>0&&(n=n+l)}else t=="right"?n=n+r-s:t=="justify"&&!a&&(i=Ie(i,o,r,e));return{text:i,x:n}},Ie=(e,t,i,r)=>{if(t.width>=i)return e;let a=e.split(" "),n=r.measureText(z()),o=Math.floor((i-t.width)/n.width),s=o/(a.length-1);for(let l=0;l<a.length-1;l++)a[l]+=z().repeat(s);return a.join(" ")},F=(e,t,i)=>{let{font:r=null}=e.text;if(!r)return t.font;i=i+"px ";let a=(r.family||"serif")+" ",n=(r.weight??100)+" ",o="";return r.style&&(o+=r.style+" "),r.variant&&(o+=r.variant+" "),o+=n,r.stretch&&(o+=r.stretch+" "),o+=i,r.height&&(o+="/"+r.height+" "),o+a};var q=(e,t,i)=>{let{group:r,start:a}=i;i.layout.length!==0&&(e.save(),e.translate(a.x,a.y),r.interaction==="fixed"?t.core.view.redraw(i.layout):we(e,t,i),e.restore())},O=(e,t)=>{let i=0,r=e.group.gap.horizontal;return t.forEach(a=>{i+=a.height+r}),i-r},G=(e,t)=>{let i=0,r=e.group.gap.vertical;return t.forEach(a=>{e.group.direction==="column"?i=Math.max(i,a.width):i+=a.width+r}),e.group.direction==="row"&&(i-=r),i},we=(e,t,i)=>{let{group:r}=i,{vertical:a,horizontal:n}=r.gap,o=H(i,i.layout);r.clip&&(!isNaN(i.size?.w)||!isNaN(i.size?.h))&&(e.beginPath(),e.rect(0,0,isNaN(i.size.w)?G(i,o):i.size.w,isNaN(i.size.h)?O(i,o):i.size.h),e.clip());let s=0,l=0;o.forEach(u=>{u.layers.forEach(c=>{c.def.start.x=l,c.def.start.y=s,c.def.area&&(c.def.area.start.x=l,c.def.area.start.y=s),t.core.view.draw(c.def),l+=c.def.size.w+a}),l=0,s+=u.height+n})},H=(e,t)=>{let{size:i}=e,r=[],a=()=>({height:0,width:0,layers:[]}),n=a();return t.forEach((o,s)=>{(e.group.wrap&&i.w!=0&&n.width+o.size.w>i.w||s!=0&&e.group.direction==="column")&&(r.push(n),n=a()),n.layers.push({x:n.width,def:o}),n.height<o.size.h&&(n.height=o.size.h),n.width+=o.size.w+e.group.gap.vertical}),r.push(n),r};var K=e=>{let t=e.polygon.size;return{start:{x:e.start.x+t.negative.x,y:e.start.y+t.negative.y},size:{w:t.positive.x-t.negative.x,h:t.positive.y-t.negative.y}}},J=async(e,t,i)=>{let r=i.illustrator,a={close:()=>{},fill:async n=>{await S(r,n.args)},line:async n=>{n.args=await r.calc({layerType:"polygon-line",purpose:"position",values:n.args}),m(e,n.args.x,"x"),m(e,n.args.y,"y")},curve:async n=>{n.args=await r.calc({layerType:"polygon-curve",purpose:"position",values:n.args}),m(e,n.args.x,"x"),m(e,n.args.cp1x,"x"),m(e,n.args.cp2x,"x"),m(e,n.args.y,"y"),m(e,n.args.cp2y,"y")},stroke:async n=>{n.args.thickness=(await r.calc({layerType:"polygon-stroke",purpose:"thickness",values:{thickness:n.args.thickness??5}})).thickness},begin:async n=>{n.args=await r.calc({layerType:"polygon-begin",purpose:"position",values:n.args}),m(e,n.args.x,"x"),m(e,n.args.y,"y")},move:async n=>{n.args=await r.calc({layerType:"polygon-move",purpose:"position",values:n.args})}};t.means||(t.means="line"),a[t.means]&&await a[t.means](t)},m=(e,t,i)=>{if(t<0){let r=e.polygon.size.negative;r[i]=Math.min(r[i],t)}else{let r=e.polygon.size.positive;r[i]=Math.max(r[i],t)}};var be={},Q={},xe=e=>({start:{x:e.start.x,y:e.start.y},size:{h:e.size.h,w:e.size.w}}),Z=async(e,t)=>{let i=e.illustrator;t.size=await i.calc({layerType:"image",purpose:"size",values:t.size}),t.start=await i.calc({layerType:"image",purpose:"position",values:t.start}),t.area=xe(t),t.image?.outline?.thickness&&(t.image.outline.thickness=(await i.calc({layerType:"image",purpose:"thickness",values:{thickness:t.image.outline.thickness}})).thickness);let r=ee(t.image),a=Q[r];if(a){t.image.calculated=Te(t,a);return}if(t.image.src instanceof Image){t.image.calculated=await $(t,t.image.src,e,r);return}if(typeof t.image.src!="string")return;let n=t.image.src;if(typeof n!="string"||!n.startsWith("blob:http")&&!n.startsWith("http")&&!n.startsWith("/")){console.warn("Image `"+n+"` has invalid source");return}let o=e.core.setting.get("illustrator.image.waitForLoad"),s=Ce(t,n,e);o&&await s},Te=(e,t)=>{let i=e.image,{w:r,h:a}=e.size,{width:n,height:o}=te(i.fit??"default",t.width,t.height,r,a),s=re(i.align?.horizontal??"center",r,n),l=ie(i.align?.vertical??"center",a,o);return new v(t.image,{xDiff:s,yDiff:l,width:n,height:o})},$=async(e,t,i,r=null)=>{let a=e.image,{w:n,h:o}=e.size,s=t.width||200,l=t.height||200,{width:u,height:c}=te(a.fit??"default",s,l,n,o),g=re(a.align?.horizontal??"center",n,u),h=ie(a.align?.vertical??"center",o,c);return a.fit==="crop"&&(t=await ze(t,e)),a.overcolor&&(t=await De(t,e,u,c)),a.outline&&(t=await Se(t,e,u,c)),Q[r??ee(e.image)]={image:t,width:s,height:l},new v(t,{xDiff:g,yDiff:h,width:u,height:c})},ee=e=>JSON.stringify({...e,timeout:void 0,calculated:void 0}),Ce=async(e,t,i)=>{let r=new Image,{image:{timeout:a=3e4}}=e,n=i.core.view;r.crossOrigin="anonymous",r.src=t;let o=new Promise((s,l)=>{let u=setTimeout(()=>{e.image.calculated=P,l(new Error("Image loading reached a timeout: "+t))},a);r.onerror=c=>{clearTimeout(u),e.image.calculated=_,l(c)},r.onload=async()=>{clearTimeout(u),e.image.calculated=await $(e,r,i),n.redrawDebounce(),s()}});be[t]=M,await o},De=async(e,t,i,r)=>{let a=document.createElement("canvas"),n=a.getContext("2d"),o=t.image.overcolor;a.setAttribute("width",String(i)),a.setAttribute("height",String(r)),n.drawImage(e,0,0,i,r),n.globalCompositeOperation="source-in",n.fillStyle=y(o.fill.type,o.fill.style),n.fillRect(0,0,a.width,a.height),n.globalCompositeOperation="source-over";let s=await A(a,e);return n.drawImage(s,0,0,i,r),A(a,s)},Se=async(e,t,i,r)=>{let a=document.createElement("canvas"),n=a.getContext("2d"),o=t.image.outline;if(!o.thickness||!o.fill)return e;let s=o.thickness,l=[[-.75,-.75],[0,-1],[.75,-.75],[1,0],[.75,.75],[0,1],[-.75,.75],[-1,0]];if(s>5){let u=Math.floor(s/2.5),c=[];for(let g=0;g<l.length;g++){c.push(l[g]);let[h,I]=l[g],[p,f]=g+1===l.length?l[0]:l[g+1],w=h>p?-1:1,b=I>f?-1:1,x=Math.abs(h-p)/u*w,E=Math.abs(I-f)/u*b,V=[],C=h,D=I;for(;(w>0&&C+x<p||w<0&&C+x>p)&&(b>0&&D+E<f||b<0&&D+E>f);)C+=x,D+=E,V.push([C,D]);c=c.concat(V)}l=c}a.setAttribute("width",String(i+s*2)),a.setAttribute("height",String(r+s*2));for(let u=0;u<l.length&&(n.drawImage(e,s+l[u][0]*s,s+l[u][1]*s,i,r),s!==0);u++);return n.globalCompositeOperation="source-in",n.fillStyle=y(o.fill.type,o.fill.style),n.fillRect(0,0,a.width,a.height),n.globalCompositeOperation="source-over",n.drawImage(e,s,s,i,r),A(a,e)},A=async(e,t)=>{let i=new Image;return i.src=e.toDataURL("image/webp"),new Promise(r=>{let a=setTimeout(()=>{r(t)},1e3);i.onerror=()=>{clearTimeout(a),r(t)},i.onload=()=>{clearTimeout(a),r(i)}})},ze=async(e,t)=>{let{w:i,h:r}=t.size,a=t.image.fitTo??"auto",n=0,o=0;a==="auto"&&(a=r>i?"height":"width"),a==="height"?n=(i-e.width*(r/e.height))/2:a==="width"&&(o=(r-e.height*(i/e.width))/2);let s=document.createElement("canvas"),l=s.getContext("2d");return s.setAttribute("width",String(i)),s.setAttribute("height",String(r)),l.drawImage(e,n,o,i-n*2,r-o*2),A(s,e)},te=(e,t,i,r,a)=>e==="stretch"||e==="crop"?{width:r,height:a}:Ae(t,i,r,a),Ae=(e,t,i,r)=>{let a=Math.min(i/e,r/t),n=e*a,o=t*a;return{width:n,height:o}},ie=(e,t,i)=>e=="top"?0:e=="bottom"?t-i:(t-i)/2,re=(e,t,i)=>e=="left"?0:e=="right"?t-i:(t-i)/2;var Ee=e=>{let t=e.text.font?.size;return(!t||typeof t=="string")&&(t=0),{start:{y:e.start.y,x:e.start.x},size:{w:e.size.w,h:e.size.h??(e.text.lineHeight??t)*(e.text.lines?.length??0)}}},ne=async(e,t,i)=>{let r=t.illustrator;e.size=await r.calc({layerType:"text",purpose:"size",values:e.size}),e.start=await r.calc({layerType:"text",purpose:"position",values:e.start});let{outlineThickness:a,fontSize:n,gap:o,lineHeight:s}=await r.calc({layerType:"text",purpose:"prepare",values:{fontSize:Y(e),lineHeight:e.text.lineHeight??0,gap:e.text.columns?.gap??0,outlineThickness:e.text.outline?.thickness??0}});e.text.lineHeight&&(e.text.lineHeight=s),e.text.outline?.thickness&&(e.text.outline.thickness=a),e.text.columns=e.text.columns??{amount:1,gap:0},e.text.columns.gap=o,e.text.font=e.text.font??{},e.text.font.size=n,typeof e.text.color?.type=="string"&&await S(r,e.text.color);let{lines:l,lineHeight:u,width:c,columns:g,fontSize:h}=Le(e,i,e.size.w);return e.text.transY=ke(e.size.h,u,l,e.text.align?.vertical||"top"),Me()&&(e.start.y-=h*.2),e.text.lineHeight=u,e.text.font.size=h,e.text.columns=g,e.size.w=c,e.text.lines=l,e.area=Ee(e),e},Le=(e,t,i)=>{let r=e.text.columns??{gap:0,amount:1},a=k(e),{textBaseline:n="top"}=e.text,{value:o}=e.text;t.save(),t.font=F(e,t,String(a)),t.textBaseline=n;let s=Pe(i,r);o=Ne(e,o);let l=Re(e,o,t,s);return t.restore(),{lines:l,fontSize:a,lineHeight:e.text.lineHeight??a,width:s,columns:r}},Re=(e,t,i,r)=>{if(!e.text.wrap)return[[t,0]];let a=[],n=t.split(/[^\S\r\n]/),o="",s=0;for(;n.length>0;){let l=n[0].search(/[\r\n]/);if(l!==-1){let c=n[0].substring(0,l);a.push([(o+" "+c).trim()+`
`,s]),o="",s++,n[0]=n[0].substring(l+1);continue}i.measureText(o+n[0]).width>r&&(o.length>0&&(a.push([o.trim(),s]),s++),o=""),o+=" "+n[0],n=n.splice(1)}return o.length>0&&a.push([o.replace(/^\s+/,""),s]),a},Ne=(e,t)=>e.text.spacing?t.split("").join(z().repeat(e.text.spacing)):t,Pe=(e,t)=>(e-(t.amount-1)*t.gap)/t.amount,Me=()=>/^((?!chrome|android).)*safari/i.test(navigator.userAgent),ke=(e,t,i,r)=>{if(!e||i.length*t>=e)return 0;let a=e-i.length*t;return r==="center"?a/2:r==="bottom"?a:0};var Fe=async e=>{let t;return e.group.interaction==="static"?t=Oe(e):(t=Ge(e),t.start.y+=e.start.y,t.start.x+=e.start.x),e.group.clip&&(isNaN(e.size.h)||(t.size.h=e.size.h),isNaN(e.size.w)||(t.size.w=e.size.w)),t},ae=e=>({size:{w:isNaN(e.size.w??NaN)?0:e.size.w,h:isNaN(e.size.h??NaN)?0:e.size.h},start:{x:0,y:0}}),Oe=e=>{let t=ae(e),i=H(e,e.layout);return t.size.h||(t.size.h=O(e,i)),t.size.w||(t.size.w=G(e,i)),t.start.x=e.start.x,t.start.y=e.start.y,t},Ge=e=>{let t=ae(e),i=!!t.size.w,r=!!t.size.h;for(let a=0;a<e.layout.length;a++){let n=e.layout[a].area;n&&(r||(t.size.h=Math.max(t.size.h,n.size.h+n.start.y)),i||(t.size.w=Math.max(t.size.w,n.size.w+n.start.x)),t.start.y=Math.min(t.start.y,n.start.y),t.start.x=Math.min(t.start.x,n.start.x))}return t.start.y<0&&(t.start.y=0),t.start.x<0&&(t.start.x=0),t},oe=async(e,t,i)=>{let{group:r}=t,a=e.illustrator;t.size=await a.calc({layerType:"group",purpose:"size",values:t.size??{w:0,h:0}}),t.size.w??=NaN,t.size.h??=NaN,t.start=await a.calc({layerType:"group",purpose:"position",values:t.start??{x:0,y:0}}),t.start.y??=0,t.start.x??=0,r.gap=await a.calc({layerType:"group",purpose:"gap",values:r.gap??{vertical:0,horizontal:0}}),r.gap.vertical??=0,r.gap.horizontal??=0;let n=e.core.setting.get("workspace")??{};n.relative??={};let o=n.relative.height,s=n.relative.width;isNaN(t.size.h)||(n.relative.height=t.size.h),isNaN(t.size.w)||(n.relative.width=t.size.w),t.layout=await e.core.view.recalculate(t,t.layout,i),r.interaction??="fixed",n.relative.height=o,n.relative.width=s,t.area=await Fe(t)};var T={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"};var He=()=>({group:{clip:"boolean",interaction:"string",direction:"string",wrap:"boolean",gap:{vertical:"number",horizontal:"number"}}}),se=He;var We=()=>({image:{timeout:"number",fit:"string",overcolor:{fill:"string"},outline:{thickness:"number",fill:"string"},align:{vertical:"string",horizontal:"string"},fitTo:"string",src:"string"}}),le=We;var Ve=()=>({polygon:{steps:[{means:"string",args:{x:"number",y:"number",cp1x:"number",cp1y:"number",cp2x:"number",cp2y:"number",thickness:"number",fill:"string",lineJoin:"string",miterLimit:"number"}}],size:{negative:{x:"number",y:"number"},positive:{x:"number",y:"number"}}}}),ce=Ve;var Be=()=>({text:{value:"string",align:{vertical:"string",horizontal:"string"},columns:{amount:"number",gap:"number"},font:{style:"string",family:"string",weight:"string",size:"string",stretch:"string",variant:"string",height:"string"},spacing:"number",textBaseline:"string",wrap:"boolean",lineHeight:"number",color:"string",outline:{fill:"string",thickness:"number",lineJoin:"string",miterLimit:"number",transY:"number",lines:[["string","number"]]}}}),ue=Be;var W=class{#e;#t;#i;#r;constructor(t,i,r){if(!t)throw new Error("[Antetype Illustrator] Provided canvas is empty");this.#e=t,this.#t=i,this.#r=r,this.#i=this.#e.getContext("2d"),this.#n()}#n(){let t=this.#r.batch([{event:T.CLOSE,subscription:()=>{t()}},{event:T.DRAW,subscription:async i=>{let{element:r}=i.detail,n={clear:this.clear.bind(this),polygon:this.polygon.bind(this),image:this.image.bind(this),text:this.text.bind(this),group:this.group.bind(this)}[r.type];typeof n=="function"&&await n(r)}},{event:T.CALC,subscription:async i=>{if(i.detail.element===null)return;let{element:r,sessionId:a}=i.detail,o={polygon:this.polygonCalc.bind(this),image:this.imageCalc.bind(this),text:this.textCalc.bind(this),group:this.groupCalc.bind(this)}[r.type];typeof o=="function"&&await o(r,a)}},{event:T.TYPE_DEFINITION,subscription:i=>{let r=i.detail.definitions;r.text=ue(),r.group=se(),r.image=le(),r.polygon=ce()}}])}reset(){this.#e.width+=0}clear(){this.#i.clearRect(0,0,this.#e.width,this.#e.height)}async groupCalc(t,i=null){await oe(this.#t,t,i)}group(t){q(this.#i,this.#t,t)}async polygonCalc(t){t.start=await this.calc({layerType:"polygon",purpose:"position",values:t.start}),t.polygon.size={negative:{x:0,y:0},positive:{x:0,y:0}};for(let i of t.polygon.steps)await J(t,i,this.#t);t.area=K(t)}polygon({polygon:{steps:t},start:{x:i,y:r}}){let a=this.#i;a.save(),a.beginPath(),a.moveTo(i,r);for(let n of t)U(a,n,i,r);a.closePath(),a.restore()}async imageCalc(t){await Z(this.#t,t)}image(t){j(this.#i,t)}async textCalc(t){await ne(t,this.#t,this.#i)}text(t){X(this.#i,t)}async calc(t){let i=new CustomEvent(N.CALC,{detail:t});return await this.#r.dispatch(i),i.detail.values}generateText(t){return{type:"text",start:{x:0,y:0},size:{w:300,h:100},text:{value:t,font:{family:"Arial",weight:400,size:30}}}}generateImage(t){return{type:"image",start:{x:0,y:0},size:{w:300,h:300},image:{src:t}}}generatePolygon(t=[]){return{type:"polygon",start:{x:0,y:0},size:{w:NaN,h:NaN},polygon:{steps:t,size:{negative:{x:0,y:0},positive:{x:0,y:0}}}}}generateGroup(t){let i={type:"group",start:{x:0,y:0},size:{w:NaN,h:NaN},group:{},layout:[]};for(let r of t)r.hierarchy={parent:i,position:i.layout.length},i.layout.push(r);return i}};export{W as default};
